<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Mapa — Red de Monitoreo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        html,body,#map{height:100%;margin:0}
        .leaflet-popup-content { font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1) Crear mapa
    const map = L.map('map', { zoomControl: true }).setView([-38.0, -57.55], 14);

    // Capa base: OpenStreetMap (fusionada)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // 2) Helpers y capas
    const layers = {}; // id -> marker/circle

    function colorFor(status){
      switch((status||'').toUpperCase()){
        case 'GREEN': return '#22c55e';
        case 'YELLOW':return '#facc15';
        case 'RED':   return '#ef4444';
        case 'ERROR': return '#7c3aed';
        default:      return '#2b2b2b';
      }
    }

    // Íconos (tus cambios)
    const cameraIcon = L.icon({ iconUrl: '/images/CameraPhoto.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
    const cameraIconError = L.icon({ iconUrl: '/images/CameraPhotoError.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
    const radarIcon = L.icon({ iconUrl: '/images/RadarPhoto.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
    const radarIconError = L.icon({ iconUrl: '/images/RadarPhotoError.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
    const parkingCameraIcon = L.icon({ iconUrl: '/images/ParkingCameraPhoto.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
    const parkingCameraIconError = L.icon({ iconUrl: '/images/ParkingCameraPhotoError.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });

    // 3) API que usa el resto del código
    window.setView = (lat,lng,zoom)=> map.setView([lat,lng], zoom);

    window.addDevices = (jsonStr)=> {
      const data = JSON.parse(jsonStr);

      // Semáforos -> círculos coloreados
      (data.semaphoreControllers||[]).forEach(sc=> {
        const m = L.circleMarker([sc.lat, sc.lng], {
          radius: 7, fillOpacity: 0.95, color:'#000', weight:1, fillColor: colorFor(sc.status)
        }).addTo(map).bindPopup(sc.id);
        layers[sc.id]=m;
      });

      // Radares (con ícono de error)
      (data.radars||[]).forEach(d=> {
        const icon = d.status === 'ERROR' ? radarIconError : radarIcon;
        const m = L.marker([d.lat, d.lng], {icon: icon}).addTo(map).bindPopup(d.id);
        layers[d.id] = m;
      });

      // Cámaras de seguridad (con ícono de error)
      (data.securityCameras||[]).forEach(d=> {
        const icon = d.status === 'ERROR' ? cameraIconError : cameraIcon;
        const m = L.marker([d.lat, d.lng], {icon: icon}).addTo(map).bindPopup(d.id);
        layers[d.id] = m;
      });
      
      // Cámaras de estacionamiento (con ícono de error)
      (data.parkingCameras||[]).forEach(pc=> {
        const icon = pc.status === 'ERROR' ? parkingCameraIconError : parkingCameraIcon;
        const m = L.marker([pc.lat, pc.lng], {icon: icon}).addTo(map)
          .bindPopup(pc.id + " (tol " + (pc.toleranceTime||0) + "s)");
        layers[pc.id]=m;
      });

      // Ajustar vista a todos
      const all = Object.values(layers);
      if(all.length){
        const group = L.featureGroup(all);
        map.fitBounds(group.getBounds().pad(0.15));
      }
    };

    window.updateSemaphoreStatus = (id, status)=> {
      const m = layers[id];
      if(m && m.setStyle) m.setStyle({ fillColor: colorFor(status) });
    };

    window.updateDeviceStatus = (id, status) => {
        const m = layers[id];
        if (!m) return;

        let icon;
        if (id.startsWith('Radar')) {
            icon = status === 'ERROR' ? radarIconError : radarIcon;
        } else if (id.startsWith('Parking Camera')) {
            icon = status === 'ERROR' ? parkingCameraIconError : parkingCameraIcon;
        } else if (id.startsWith('Camera')) {
            icon = status === 'ERROR' ? cameraIconError : cameraIcon;
        }

        if (icon) m.setIcon(icon);
    };

    // 4) Cargar datos desde archivo estático (colocar devices.json en /static)
    fetch('/devices.json')
      .then(r => {
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      })
      .then(data => window.addDevices(JSON.stringify(data)))
      .catch(err => console.error('Error cargando devices.json:', err));
</script>
</body>
</html>
