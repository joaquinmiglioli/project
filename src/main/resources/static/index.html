<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>City Monitor</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html,body,#map{height:100%;margin:0}
        .leaflet-popup-content{font:13px/1.2 sans-serif}

        .devices-control{
          position:absolute;
          top:20px; right:20px;
          z-index:1000;
        }
        .devices-panel{
          background:#fff;
          border:1px solid #d1d5db;
          border-radius:12px;
          padding:12px;
          box-shadow:0 4px 10px rgba(0,0,0,0.15);
          min-width:220px;
          font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
        }
        .devices-title{
          font-weight:600;
          margin-bottom:8px;
          text-align:center;
        }
        .devices-option{
          display:flex;
          align-items:center;
          justify-content:space-between;
          padding:8px 0;
          gap:10px;
          font-size:14px;
        }

        .switch {
          position: relative;
          display: inline-block;
          width: 44px;
          height: 26px;
          flex-shrink: 0;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .switch-slider {
          position: absolute; cursor: pointer; inset: 0;
          background: #d1d5db; border-radius: 999px; transition: background .2s ease;
        }
        .switch-slider::before{
          content:""; position:absolute; height:22px; width:22px; left:2px; top:2px;
          background:#fff; border-radius:999px; box-shadow:0 1px 3px rgba(0,0,0,.25);
          transition: transform .2s ease;
        }
        .switch input:checked + .switch-slider{ background:#22c55e; }
        .switch input:checked + .switch-slider::before{ transform: translateX(18px); }
        .switch input:focus-visible + .switch-slider{ outline:2px solid #2563eb; outline-offset:2px; }
        @media (prefers-reduced-motion: reduce) {
          .switch-slider, .switch-slider::before { transition: none; }
        }
    </style>
</head>
<body>
<div id="map" aria-label="City map"></div>

<div class="devices-control">
    <div id="devicesPanel" class="devices-panel" role="group" aria-label="Show devices">
        <div class="devices-title">Show Devices</div>

        <div class="devices-option">
            <label for="chkRadars">Radars</label>
            <label class="switch"><input type="checkbox" id="chkRadars" checked><span class="switch-slider"></span></label>
        </div>
        <div class="devices-option">
            <label for="chkParking">Parking Cameras</label>
            <label class="switch"><input type="checkbox" id="chkParking" checked><span class="switch-slider"></span></label>
        </div>
        <div class="devices-option">
            <label for="chkSecurity">Cameras</label>
            <label class="switch"><input type="checkbox" id="chkSecurity" checked><span class="switch-slider"></span></label>
        </div>
        <div class="devices-option">
            <label for="chkSemaphores">Semaphores</label>
            <label class="switch"><input type="checkbox" id="chkSemaphores" checked><span class="switch-slider"></span></label>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function(){

      const map = L.map('map', { zoomControl: true }).setView([-38.0, -57.55], 15);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap, ¬© CARTO'
      }).addTo(map);

      const groups = {
        radars: L.layerGroup().addTo(map),
        parking: L.layerGroup().addTo(map),
        security: L.layerGroup().addTo(map),
        semaphores: L.layerGroup().addTo(map)
      };

      const deviceLayers = new Map();

      function mkIcon(url){
        return L.icon({
          iconUrl: url,
          iconSize: [30, 30],
          iconAnchor: [15, 30],
          popupAnchor: [0, -28]
        });
      }

      const ICONS = {
        radar:   { ok: mkIcon('/images/RadarPhoto.png'),         err: mkIcon('/images/RadarPhotoError.png') },
        parking: { ok: mkIcon('/images/ParkingCameraPhoto.png'), err: mkIcon('/images/ParkingCameraPhotoError.png') },
        camera:  { ok: mkIcon('/images/CameraPhoto.png'),        err: mkIcon('/images/CameraPhotoError.png') }
      };

      function isErrorStatus(s){ return String(s || '').toUpperCase() === 'ERROR'; }
      function colorFor(status){
        switch((status||'').toUpperCase()){
          case 'GREEN': return '#22c55e';
          case 'YELLOW':return '#facc15';
          case 'RED':   return '#ef4444';
          case 'ERROR': return '#7c3aed';
          default:      return '#2b2b2b';
        }
      }

      const chkRadars     = document.getElementById('chkRadars');
      const chkParking    = document.getElementById('chkParking');
      const chkSecurity   = document.getElementById('chkSecurity');
      const chkSemaphores = document.getElementById('chkSemaphores');

      function applyVisibility(){
        (chkRadars.checked     ? groups.radars.addTo(map)     : map.removeLayer(groups.radars));
        (chkParking.checked    ? groups.parking.addTo(map)    : map.removeLayer(groups.parking));
        (chkSecurity.checked   ? groups.security.addTo(map)   : map.removeLayer(groups.security));
        (chkSemaphores.checked ? groups.semaphores.addTo(map) : map.removeLayer(groups.semaphores));
      }
      chkRadars.onchange = applyVisibility;
      chkParking.onchange = applyVisibility;
      chkSecurity.onchange = applyVisibility;
      chkSemaphores.onchange = applyVisibility;

      function addDevices(data){
        groups.radars.clearLayers();
        groups.parking.clearLayers();
        groups.security.clearLayers();
        groups.semaphores.clearLayers();
        deviceLayers.clear();

        const ftrs = [];

        (data.radars||[]).forEach(r => {
          const ic = isErrorStatus(r.status) ? ICONS.radar.err : ICONS.radar.ok;
          const m = L.marker([r.lat, r.lng], { icon: ic }).bindPopup(`<b>${r.id}</b><br>Status: ${r.status||'?'}`);
          m.addTo(groups.radars);
          deviceLayers.set(r.id, m);
          ftrs.push(m);
        });

        (data.parkingCameras||[]).forEach(p => {
          const ic = isErrorStatus(p.status) ? ICONS.parking.err : ICONS.parking.ok;
          const m = L.marker([p.lat, p.lng], { icon: ic }).bindPopup(`<b>${p.id}</b><br>Tolerance: ${p.toleranceTime||0}s<br>Status: ${p.status||'?'}`);
          m.addTo(groups.parking);
          deviceLayers.set(p.id, m);
          ftrs.push(m);
        });

        (data.securityCameras||[]).forEach(c => {
          const ic = isErrorStatus(c.status) ? ICONS.camera.err : ICONS.camera.ok;
          const m = L.marker([c.lat, c.lng], { icon: ic }).bindPopup(`<b>${c.id}</b><br>Status: ${c.status||'?'}`);
          m.addTo(groups.security);
          deviceLayers.set(c.id, m);
          ftrs.push(m);
        });

        (data.semaphoreControllers||[]).forEach(s => {
          const cm = L.circleMarker([s.lat, s.lng], {
            radius: 7,
            fillOpacity: 0.95,
            color:'#000',
            weight:1,
            fillColor: colorFor(s.status)
          }).bindPopup(`<b>${s.id}</b><br>Status A: ${s.status||'?'}<br>Status B: ?`);
          cm.addTo(groups.semaphores);
          deviceLayers.set(s.id, cm);
          ftrs.push(cm);
        });

        if (ftrs.length){
          const g = L.featureGroup(ftrs);
          map.fitBounds(g.getBounds().pad(0.15));
        }

        applyVisibility();
      }

      async function loadDevices(){
        try{
          const res = await fetch('/api/devices', { cache: 'no-store' });
          if(!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          addDevices(data);
        }catch(err){
          console.warn('No se pudo cargar /api/devices.', err);
        }
      }

      loadDevices();

      window.updateSemaphoreStatus = (id, statusA, statusB) => {
        const m = deviceLayers.get(id);
        if(m && m.setStyle){
          m.setStyle({ fillColor: colorFor(statusA) });
          if (m.getPopup()){
            m.setPopupContent(`<b>${id}</b><br>Status A: ${statusA||'?'}<br>Status B: ${statusB||'?'}`);
          }
        }
      };

      // üîÅ Consultar estados de sem√°foros cada 3s
      async function updateTrafficLights(){
        try {
          const res = await fetch('/api/trafficlights');
          if(!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          data.forEach(tl => {
            window.updateSemaphoreStatus(tl.id, tl.a, tl.b);
          });
        } catch (e) {
          console.error('‚ùå Error actualizando sem√°foros:', e);
        }
      }

      setInterval(updateTrafficLights, 3000);
    });
</script>
</body>
</html>
