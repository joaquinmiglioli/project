<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>City Monitor</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html,body,#map{height:100%;margin:0}
        .leaflet-popup-content{font:13px/1.35 sans-serif}

        /* Empuja los controles de zoom para no tapar el header */
        .leaflet-top.leaflet-left{ top:72px; }

        /* Panel switches */
        .devices-control{position:absolute; top:84px; right:20px; z-index:900;}
        .devices-panel{background:#fff; border:1px solid #d1d5db; border-radius:12px; padding:12px; box-shadow:0 4px 10px rgba(0,0,0,0.15); min-width:220px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
        .devices-title{font-weight:600; margin-bottom:8px; text-align:center;}
        .devices-option{display:flex; align-items:center; justify-content:space-between; padding:8px 0; gap:10px; font-size:14px;}
        .switch{position:relative; display:inline-block; width:44px; height:26px; flex-shrink:0;}
        .switch input{opacity:0; width:0; height:0;}
        .switch-slider{position:absolute; cursor:pointer; inset:0; background:#d1d5db; border-radius:999px; transition:background .2s ease;}
        .switch-slider::before{content:""; position:absolute; height:22px; width:22px; left:2px; top:2px; background:#fff; border-radius:999px; box-shadow:0 1px 3px rgba(0,0,0,.25); transition: transform .2s ease;}
        .switch input:checked + .switch-slider{background:#22c55e;}
        .switch input:checked + .switch-slider::before{transform: translateX(18px);}
        .switch input:focus-visible + .switch-slider{outline:2px solid #2563eb; outline-offset:2px;}

        /* --- ‚úÖ NUEVO ESTILO PARA EL SWITCH DE FALLAS --- */
        #chkFails + .switch-slider { background: #fca5a5; } /* Color rojo claro cuando est√° apagado */
        #chkFails:checked + .switch-slider { background: #b91c1c !important; } /* Color rojo oscuro cuando est√° encendido */
        /* --- FIN NUEVO ESTILO --- */

        /* Header */
        .appbar{position:absolute; top:0; left:0; right:0; height:64px; background:#111827; color:#fff; z-index:950; display:flex; align-items:center; gap:14px; padding:0 16px; box-shadow: 0 6px 18px rgba(0,0,0,.35);}
        .brand{font-weight:900; letter-spacing:.5px;}
        .tab{background:transparent; border:0; color:#e5e7eb; font-weight:700; padding:8px 12px; border-radius:8px; cursor:pointer;}
        .tab[aria-selected="true"]{background:#1f2937; color:#fff;}
        .tab:hover{background:#1f2937;}
        .spacer{flex:1}

        /* Drawer */
        .drawer{position:absolute; top:64px; left:12px; z-index:920; width: 420px; max-width: calc(100% - 24px); background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 18px 40px rgba(0,0,0,.25); display:none; max-height: calc(100% - 84px); overflow:auto; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
        .drawer header{position:sticky; top:0; background:#f9fafb; border-bottom:1px solid #e5e7eb; padding:10px 12px; display:flex; align-items:center; gap:8px;}
        .drawer header h3{margin:0; font-size:16px;}
        .drawer .content{padding:12px;}
        .row{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
        .btn{border:1px solid #e5e7eb; background:#fff; color:#111827; border-radius:8px; padding:6px 10px; cursor:pointer;}
        .btn.ghost{background:#111827; color:#fff; border-color:#111827;}
        .btn.danger{background:#ef4444; color:#fff; border-color:#ef4444;}
        .pill{font-size:12px; background:#f3f4f6; border-radius:999px; padding:4px 8px; border:1px solid #e5e7eb;}

        /* Toast */
        #toast-container{position:fixed; top:18px; left:50%; transform:translateX(-50%); z-index:2000; display:flex; flex-direction:column; align-items:center; gap:10px; pointer-events:none; width:min(92%, 520px);}
        .toast{width:100%; background:#111827; color:white; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.08); pointer-events:auto; cursor:pointer; overflow:hidden; position:relative; animation: toast-in 250ms ease-out, toast-hold 3.2s linear 250ms, toast-out 300ms ease-in 3.45s forwards;}
        .toast .title{font-weight:700; font-size:15px; margin-bottom:4px;}
        .toast .subtitle{font-size:13px; color:#e5e7eb; opacity:.95;}
        .toast::after{content:""; position:absolute; left:0; bottom:0; height:3px; width:100%; background:#ef4444; animation: toast-bar 3.8s linear forwards;}
        @keyframes toast-in{from{opacity:0; transform: translateY(-8px);} to{opacity:1; transform: translateY(0);}}
        @keyframes toast-hold{from{opacity:1;} to{opacity:1;}}
        @keyframes toast-out{to{opacity:0; transform: translateY(-8px);}}
        @keyframes toast-bar{from{width:100%} to{width:0%}}

        /* Popups */
        .popup-card{width:240px; border-radius:12px; overflow:hidden; border:1px solid #e5e7eb; box-shadow:0 8px 20px rgba(0,0,0,0.12); background:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
        .popup-header{display:flex; align-items:center; gap:8px; padding:8px 10px; color:#fff; font-weight:700; font-size:14px;}
        .popup-body{padding:10px; color:#111827; font-size:13px;}
        .popup-row{display:flex; justify-content:space-between; padding:4px 0;}
        .popup-k{color:#6b7280;} .popup-v{font-weight:600; color:#111827;}
        .ph-radar{background:#b91c1c;} .ph-parking{background:#0b5;} .ph-camera{background:#2563eb;} .ph-sema{background:#6b7280;}

        /* Security overlay: NO abre al iniciar */
        #securityOverlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:1500; align-items:center; justify-content:center;}
        #securityOverlay.open{display:flex;}
        #securityCard{background:#111827; color:#fff; width:min(92%, 860px); border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,.45); overflow:hidden;}
        .sw-btn{background:#1f2937; color:#fff; border:1px solid #374151; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:700;}
        .sw-btn-ghost{background:transparent; border-color:#374151;}

        /* ‚úÖ --- NUEVOS ESTILOS PARA EL FORMULARIO --- */
        .form-box{border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-top: 16px;}
        .form-box h4{margin:0 0 10px 0;}
        .form-grid{display:grid; grid-template-columns: 1fr 1fr; gap: 10px 12px;}
        .form-group{display:flex; flex-direction:column; gap: 4px;}
        .form-group label{font-size:13px; font-weight:600;}
        .form-input, .form-select{
            width:100%;
            padding:6px 8px;
            border-radius:8px;
            border:1px solid #d1d5db;
            background:#fff;
            font-size:14px;
            box-sizing: border-box; /* Asegura que el padding no desborde */
        }
        .form-group.full-width{grid-column: 1 / -1;}
        /* --- FIN DE NUEVOS ESTILOS --- */

    </style>
</head>
<body>
<div class="appbar">
    <div class="brand">City Monitor</div>
    <button id="tabLogs" class="tab" aria-selected="false">Logs</button>
    <button id="tabEvents" class="tab" aria-selected="false">Events</button>
    <button id="tabFines" class="tab" aria-selected="false">Fines</button>

    <button id="tabSettings" class="tab" aria-selected="false" style="margin-left:12px;">Settings</button>

    <div class="spacer"></div>
</div>

<div id="drawer" class="drawer" role="dialog" aria-modal="false" aria-hidden="true">
    <header>
        <h3 id="drawerTitle">Panel</h3>
        <div class="spacer"></div>
        <button id="drawerClose" class="btn">Close</button>
    </header>
    <div class="content" id="drawerContent"></div>
</div>

<div id="map" aria-label="City map"></div>

<div class="devices-control">
    <div id="devicesPanel" class="devices-panel" role="group" aria-label="Show devices">
        <div class="devices-title">Show devices</div>
        <div class="devices-option"><label for="chkRadars">Radars</label><label class="switch"><input type="checkbox" id="chkRadars" checked><span class="switch-slider"></span></label></div>
        <div class="devices-option"><label for="chkParking">Parking Cameras</label><label class="switch"><input type="checkbox" id="chkParking" checked><span class="switch-slider"></span></label></div>
        <div class="devices-option"><label for="chkSecurity">Cameras</label><label class="switch"><input type="checkbox" id="chkSecurity" checked><span class="switch-slider"></span></label></div>
        <div class="devices-option"><label for="chkSemaphores">Semaphores</label><label class="switch"><input type="checkbox" id="chkSemaphores" checked><span class="switch-slider"></span></label></div>

        <div class="devices-option" style="border-top:1px solid #e5e7eb; margin-top:4px; padding-top:8px;">
            <label for="chkFails" style="color:#b91c1c; font-weight:700;">Show Fails Only</label>
            <label class="switch">
                <input type="checkbox" id="chkFails">
                <span class="switch-slider"></span>
            </label>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="securityOverlay">
    <div id="securityCard">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#1f2937;">
            <div id="securityTitle" style="font-weight:800;">Security Camera</div>
            <button id="btnSecClose" aria-label="Close" style="background:transparent; border:0; color:#e5e7eb; font-size:22px; cursor:pointer;">‚úï</button>
        </div>
        <div style="display:flex; gap:16px; padding:14px;">
            <div style="flex:3; background:#0b0f17; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; min-height:420px;">
                <img id="securityImage" alt="Security frame" style="max-width:100%; max-height:70vh; display:block;">
            </div>
            <div style="flex:2; display:flex; flex-direction:column; gap:10px;">
                <div style="background:#0b0f17; border-radius:10px; padding:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">Acciones r√°pidas</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <button id="btnPolice" class="sw-btn">üöì&nbsp;Police</button>
                        <button id="btnAmb"    class="sw-btn">üöë&nbsp;Ambulance</button>
                        <button id="btnFire"   class="sw-btn">üöí&nbsp;Fire Dept.</button>
                        <button id="btnExit"   class="sw-btn sw-btn-ghost">‚úñÔ∏è&nbsp;Exit</button>
                    </div>
                </div>
                <div style="background:#0b0f17; border-radius:10px; padding:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">Nota (opcional)</div>
                    <textarea id="secNote" rows="4" style="width:100%; resize:vertical; background:#111827; border:1px solid #374151; color:#fff; border-radius:8px; padding:8px;"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function(){

      /* ================== MAPA ================== */
      const map = L.map('map', { zoomControl: true }).setView([-38.0, -57.55], 15);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap, ¬© CARTO' }).addTo(map);

      // --- ‚úÖ INICIO: JAVASCRIPT MODIFICADO ---
      // Se crean grupos duplicados: uno para dispositivos OK y otro para los fallados
      const groups = {
        radars: L.layerGroup(),
        parking: L.layerGroup(),
        security: L.layerGroup(),
        semaphores: L.layerGroup(),
        radars_fail: L.layerGroup(),
        parking_fail: L.layerGroup(),
        security_fail: L.layerGroup(),
        semaphores_fail: L.layerGroup()
      };
      // --- ‚úÖ FIN: JAVASCRIPT MODIFICADO ---

      const deviceLayers = new Map();

      function mkIcon(u){ return L.icon({iconUrl:u, iconSize:[30,30], iconAnchor:[15,30], popupAnchor:[0,-28]}); }
      const ICONS = {
        radar:   { ok: mkIcon('/images/icons/RadarPhoto.png'),         err: mkIcon('/images/icons/RadarPhotoError.png') },
        parking: { ok: mkIcon('/images/icons/ParkingCameraPhoto.png'), err: mkIcon('/images/icons/ParkingCameraPhotoError.png') },
        camera:  { ok: mkIcon('/images/icons/CameraPhoto.png'),        err: mkIcon('/images/icons/CameraPhotoError.png') }
      };
      const isErr = s => String(s||'').toUpperCase()==='ERROR';
      const colorFor = s => ({GREEN:'#22c55e',YELLOW:'#facc15',RED:'#ef4444',ERROR:'#7c3aed'})[String(s||'').toUpperCase()] || '#2b2b2b';

      function header(type,title){const cls=type==='radar'?'ph-radar':type==='parking'?'ph-parking':type==='camera'?'ph-camera':'ph-sema'; const e=type==='radar'?'‚ö°':type==='parking'?'üÖøÔ∏è':type==='camera'?'üì∏':'üö¶'; return `<div class="popup-header ${cls}">${e} ${title}</div>`;}
      const row=(k,v)=>`<div class="popup-row"><span class="popup-k">${k}</span><span class="popup-v">${v}</span></div>`;
      const card=(t,id,rows)=>`<div class="popup-card">${header(t,id)}<div class="popup-body">${rows}</div></div>`;

      // --- ‚úÖ INICIO: JAVASCRIPT MODIFICADO ---
      // Se definen los checkboxes fuera de la funci√≥n para que sean globales
      const chkRadars = document.getElementById('chkRadars'),
            chkParking = document.getElementById('chkParking'),
            chkSecurity = document.getElementById('chkSecurity'),
            chkSemaphores = document.getElementById('chkSemaphores'),
            chkFails = document.getElementById('chkFails'); // El nuevo checkbox

      // La funci√≥n de visibilidad ahora decide qu√© grupos (normales o fallados) mostrar
      function applyVisibility() {
        const showFailsOnly = chkFails.checked;

        // Funci√≥n helper para no repetir l√≥gica
        const setVisibility = (normalGroup, failGroup, isChecked) => {
            // Siempre quitar ambos grupos primero
            map.removeLayer(normalGroup);
            map.removeLayer(failGroup);

            if (isChecked) {
                if (showFailsOnly) {
                    // Si "Show Fails Only" est√° activo, solo a√±adir el grupo de fallados
                    map.addLayer(failGroup);
                } else {
                    // Si no, a√±adir ambos grupos (normales Y fallados)
                    map.addLayer(normalGroup);
                    map.addLayer(failGroup);
                }
            }
            // Si isChecked es false, ambos grupos permanecen quitados
        };

        setVisibility(groups.radars, groups.radars_fail, chkRadars.checked);
        setVisibility(groups.parking, groups.parking_fail, chkParking.checked);
        setVisibility(groups.security, groups.security_fail, chkSecurity.checked);
        setVisibility(groups.semaphores, groups.semaphores_fail, chkSemaphores.checked);
      }
      // Asignar el evento a TODOS los checkboxes
      chkRadars.onchange = applyVisibility;
      chkParking.onchange = applyVisibility;
      chkSecurity.onchange = applyVisibility;
      chkSemaphores.onchange = applyVisibility;
      chkFails.onchange = applyVisibility; // El nuevo checkbox tambi√©n dispara la funci√≥n
      // --- ‚úÖ FIN: JAVASCRIPT MODIFICADO ---

      async function repairDevice(id){
        try{
          let res = await fetch(`/api/devices/${encodeURIComponent(id)}/repair`);
          if(!res.ok) res = await fetch(`/api/devices/${encodeURIComponent(id)}/status?action=REPAIR`, {method:'POST'});
          await loadDevices(); // Recargar todos los dispositivos para que cambien de grupo
        }catch(e){console.error(e);}
      }
      function repairBtn(item){
        const st = String(item.status||'').toUpperCase();
        if (['ERROR','YELLOW','INTERMITTENT','FAILURE'].includes(st)){
          return `<div style="margin-top:8px;text-align:right"><button class="btn btn-ghost btn-rep" data-id="${item.id}">Repair</button></div>`;
        }
        return '';
      }
      function attachRepair(ev, id){
        const b = ev.popup.getElement().querySelector('.btn-rep'); if(b) b.addEventListener('click',()=>repairDevice(id));
      }

      function addDevices(data){
        // Limpiar todos los grupos, incluyendo los nuevos de fallas
        Object.values(groups).forEach(g => g.clearLayers());
        deviceLayers.clear();
        const ftrs=[];

        (data.radars||[]).forEach(r=>{
          const ic=isErr(r.status)?ICONS.radar.err:ICONS.radar.ok;
          const m=L.marker([r.lat,r.lng],{icon:ic}).bindPopup(card('radar',r.id, row('Status',r.status||'?')+row('Speed limit',(r.speedLimit??r.limit??'-')+' km/h')+repairBtn(r)));
          m.on('popupopen',ev=>attachRepair(ev,r.id));
          (isErr(r.status) ? groups.radars_fail : groups.radars).addLayer(m);
          deviceLayers.set(r.id,m); ftrs.push(m);
        });
        (data.parkingCameras||[]).forEach(p=>{
          const ic=isErr(p.status)?ICONS.parking.err:ICONS.parking.ok;
          const m=L.marker([p.lat,p.lng],{icon:ic}).bindPopup(card('parking',p.id, row('Status',p.status||'?')+row('Tolerance',(p.toleranceTime??p.toleranceSec??0)+' s')+repairBtn(p)));
          m.on('popupopen',ev=>attachRepair(ev,p.id));
          (isErr(p.status) ? groups.parking_fail : groups.parking).addLayer(m);
          deviceLayers.set(p.id,m); ftrs.push(m);
        });
        (data.cameras||data.securityCameras||[]).forEach(c=>{
          const ic=isErr(c.status)?ICONS.camera.err:ICONS.camera.ok;
          const m=L.marker([c.lat,c.lng],{icon:ic}).bindPopup(card('camera',c.id, row('Status',c.status||'?')+repairBtn(c)));
          m.on('popupopen',ev=>attachRepair(ev,c.id));
          if(!isErr(c.status)){ m.on('click',()=>setTimeout(()=>openSecurityOverlay(c.id),50)); }
          (isErr(c.status) ? groups.security_fail : groups.security).addLayer(m);
          deviceLayers.set(c.id,m); ftrs.push(m);
        });

        // --- ‚úÖ INICIO DE LA CORRECCI√ìN EN SEM√ÅFOROS ---
        (data.semaphores||[]).forEach(s=>{
          // L√≥gica de color corregida:
          // 1. Determinar el color: si el status del dispositivo es ERROR, usar color 'ERROR' (violeta).
          // 2. Si no, usar el color de la luz principal (s.a).
          const markerColor = isErr(s.status) ? colorFor('ERROR') : colorFor(s.a);

          const cm=L.circleMarker([s.lat,s.lng],{
            radius:7,
            fillOpacity:.95,
            color:'#000',
            weight:1,
            fillColor: markerColor,
            deviceStatus: s.status // <-- Guardamos el estado del dispositivo aqu√≠
          }).bindPopup(card('sema',s.id, row('Dev. Status', s.status || '?') + row('Light A',s.a||'?')+row('Light B',s.b||'?')+repairBtn(s)));

          cm.on('popupopen',ev=>attachRepair(ev,s.id));
          // A√±adir al grupo correcto (normal o fallado) basado en el estado del dispositivo
          (isErr(s.status) ? groups.semaphores_fail : groups.semaphores).addLayer(cm);
          deviceLayers.set(s.id,cm); ftrs.push(cm);
        });
        // --- ‚úÖ FIN DE LA CORRECCI√ìN ---

        if(ftrs.length){const g=L.featureGroup(ftrs); map.fitBounds(g.getBounds().pad(.15));}
        applyVisibility(); // Aplicar la visibilidad inicial
      }
      async function loadDevices(){ try{ const r=await fetch('/api/devices',{cache:'no-store'}); if(!r.ok) throw 0; addDevices(await r.json()); }catch(e){ console.warn('Could not load /api/devices',e); } }
      loadDevices(); // Carga inicial

      // Esta funci√≥n actualiza el color de la LUZ del sem√°foro, no su estado de FALLA.
      // El estado de falla (c√≠rculo violeta) solo se actualiza con loadDevices().
      window.updateSemaphoreStatus=(id,a,b)=>{
        const m=deviceLayers.get(id);

        // 1. Actualizar el color de la luz (SOLO si el dispositivo no est√° en ERROR)
        //    Lee el 'deviceStatus' que guardamos en el marker.
        if (m && m.setStyle && !isErr(m.options.deviceStatus)) {
            m.setStyle({fillColor: colorFor(a)});
        }

        // 2. Actualizar el popup (siempre)
        if(m && m.getPopup()) {
            const currentStatus = m.options.deviceStatus || 'READY'; // Usar el status guardado
            m.setPopupContent(card('sema',id, row('Dev. Status', currentStatus) + row('Light A',a||'?')+row('Light B',b||'?')+repairBtn({id, status:currentStatus})));
        }
      };
      async function updateTrafficLights(){ try{ const r=await fetch('/api/trafficlights'); if(!r.ok) throw 0; (await r.json()).forEach(tl=>window.updateSemaphoreStatus(tl.id, tl.a, tl.b)); }catch(e){} }
      setInterval(updateTrafficLights, 800); // Esto sigue actualizando el popup de los sem√°foros OK

      function showToast(title,sub){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className='toast';t.innerHTML=`<div class="title">${title}</div><div class="subtitle">${sub}</div>`;c.appendChild(t);const rm=()=>t.remove();t.addEventListener('click',rm);setTimeout(rm,4000);}
      async function checkForFines(){ try{ const r=await fetch('/api/lastFine',{cache:'no-store'}); if(!r.ok) return; const data=await r.json?.()??{}; if(!data || Object.keys(data).length===0){ const text=await r.text(); if(text&&text.trim()!==""){ showToast("üö® New fine generated","Violation PDF created."); await fetch('/api/clearFine'); } return;} if(data.fineNumber||data.plate||data.type){ const sub=`N¬∫ ${data.fineNumber??'-'} ‚Ä¢ ${data.type??'Violation'} ‚Ä¢ ${data.plate??''}`; showToast("üö® New fine generated",sub); await fetch('/api/clearFine'); } }catch(e){} }
      setInterval(checkForFines, 5000);

      /* ============ Security overlay ============ */
      const overlay=document.getElementById('securityOverlay'), imgEl=document.getElementById('securityImage'), titleEl=document.getElementById('securityTitle'), noteEl=document.getElementById('secNote'), btnClose=document.getElementById('btnSecClose'), btnPolice=document.getElementById('btnPolice'), btnAmb=document.getElementById('btnAmb'), btnFire=document.getElementById('btnFire'), btnExit=document.getElementById('btnExit');
      let currentCameraId=null, currentImagePath=null, imgsCache=null;
      async function listSecurityImages(){ if(imgsCache) return imgsCache; try{ const r=await fetch('/api/security/images',{cache:'no-store'}); if(!r.ok) throw 0; const arr=await r.json(); imgsCache=Array.isArray(arr)?arr:[]; }catch{ imgsCache=[]; } return imgsCache; }
      const pick=arr=>!arr?.length?null:arr[Math.floor(Math.random()*arr.length)];
      async function openSecurityOverlay(id){ currentCameraId=id; titleEl.textContent=`Security Camera ‚Ä¢ ${id}`; noteEl.value=''; const arr=await listSecurityImages(); currentImagePath=pick(arr) || '/images/CameraPhoto.png'; imgEl.src=currentImagePath; overlay.classList.add('open'); }
      function closeOverlay(){ overlay.classList.remove('open'); currentCameraId=null; currentImagePath=null; noteEl.value=''; }
      btnClose.onclick=closeOverlay; btnExit.onclick=closeOverlay;

      async function sendSW(service){
        if(!currentCameraId) return;
        try{
          const p=new URLSearchParams(); p.set('cameraId', currentCameraId); p.set('service', service); if(currentImagePath) p.set('imagePath', currentImagePath); const note=(noteEl.value||'').trim(); if(note) p.set('note', note);
          const r=await fetch('/api/security/notify',{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString()});
          if(!r.ok) throw 0; showToast('üìü Security notification sent', `${service} ‚Ä¢ ${currentCameraId}`); closeOverlay();
        }catch(e){ showToast('‚ö†Ô∏è Error','Could not send security notification'); }
      }
      btnPolice.onclick=()=>sendSW('POLICE');
      btnAmb.onclick   =()=>sendSW('AMBULANCE');
      btnFire.onclick  =()=>sendSW('FIREMAN');

      /* ============ Drawer (Logs / Eventos / Multas) ============ */
      const drawer=document.getElementById('drawer'), drawerTitle=document.getElementById('drawerTitle'), drawerContent=document.getElementById('drawerContent'), drawerClose=document.getElementById('drawerClose');

      const tabLogs=document.getElementById('tabLogs'), tabEvents=document.getElementById('tabEvents'), tabFines=document.getElementById('tabFines'), tabSettings=document.getElementById('tabSettings');

      function openDrawer(title){ drawerTitle.textContent=title; drawer.style.display='block'; drawer.setAttribute('aria-hidden','false'); }
      function closeDrawer(){ drawer.style.display='none'; drawer.setAttribute('aria-hidden','true'); }
      drawerClose.onclick=closeDrawer;

      function selectTab(btn){ [tabLogs,tabEvents,tabFines,tabSettings].forEach(b=>b.setAttribute('aria-selected','false')); btn.setAttribute('aria-selected','true'); }

      function fmtTs(ts){
        if (!ts) return 'N/A';
        try{ return new Date(ts).toLocaleString(); }catch{ return ts; }
      }

      function renderLogs(items){
        const html = `
          <div class="row" style="margin-bottom:10px">
            <span class="pill">Total: ${items.length}</span>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px">
            ${items.map(it=>`
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:8px">
                <div><b>${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                <div style="font-size:12px; color:#6b7280">${fmtTs(it.timestamp)}</div>
                ${it.note?`<div style="margin-top:6px">${it.note}</div>`:''}
                ${it.imagePath?`<div style="margin-top:6px"><a href="${it.imagePath}" target="_blank" rel="noopener">ver</a></div>`:''}
              </div>`).join('')}
          </div>`;
        drawerContent.innerHTML=html;
      }

      function renderFines(fines){
        const html = `
          <div class="row" style="margin-bottom:10px">
            <button id="btnClearFines" class="btn danger">Delete all</button>
            <span class="pill">Total: ${fines.length}</span>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px">
            ${fines.map(f=>`
              <div style="border:1px solid #e5e7eb; border-radius:10px; padding:8px">

                <div><b>#${f.fineId ?? '-'}</b> ‚Ä¢ ${f.type ?? 'FINE'}</div>

                <div class="row" style="font-size:12px; color:#6b7280">
                  <span>${f.plate ?? '-'}</span>
                  <span>${f.amount!=null?('$ '+f.amount):''}</span>

                  <span>${fmtTs(f.fineDate)}</span>

                </div>
                ${f.pdfPath?`<div style="margin-top:6px"><a class="btn" href="${f.pdfPath}" target="_blank" rel="noopener">Ver PDF</a></div>`:''}
              </div>`).join('')}
          </div>`;
        drawerContent.innerHTML=html;
        const btn=document.getElementById('btnClearFines');
        if(btn) btn.onclick = async ()=>{
          if(!confirm('Are you sure you want to delete all fines?')) return;
          try{ const r=await fetch('/api/fines',{method:'DELETE'}); if(!r.ok) throw 0; showToast('üßπ Cleaned fines','All fines were deleted successfully'); loadFines(); }catch(e){ showToast('‚ö†Ô∏è Error','Could not clear fines'); }
        };
      }

      async function loadLogs(){
        try{
          let r=await fetch('/api/security/logs');
          if(!r.ok) r=await fetch('/api/security/log');
          if(!r.ok) throw 0;
          renderLogs(await r.json());
            }catch(e){ drawerContent.innerHTML='<div class="pill">Error loading logs</div>'; }
      }

      async function loadFines(){
        try{ const r=await fetch('/api/fines'); if(!r.ok) throw 0; renderFines(await r.json()); }
        catch(e){ drawerContent.innerHTML='<div class="pill">Error loading fines</div>'; }
      }

      async function loadEvents(){
        try {
          let wr=await fetch('/api/security/logs'); if(!wr.ok) wr=await fetch('/api/security/log');
          const fr=await fetch('/api/fines');
          const warnings = wr.ok ? await wr.json() : [];
          const fines    = fr.ok ? await fr.json() : [];
          const html = `
            <div class="row" style="margin-bottom:10px">
              <span class="pill">Security Cam Notifications: ${warnings.length}</span>
              <span class="pill">Fines: ${fines.length}</span>
            </div>
            <div style="display:flex; flex-direction:column; gap:14px">
              <div><h4>üîî Security Cam Notifications</h4>${warnings.length? '' : '<div class="pill">No registers</div>'}</div>
              ${warnings.map(it=>`
                <div style="border:1px solid #e5e7eb; border-radius:10px; padding:8px">
                  <div><b>${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                  <div style="font-size:12px; color:#6b7280">${fmtTs(it.timestamp)}</div>
                  ${it.note?`<div style="margin-top:6px">${it.note}</div>`:''}
                </div>`).join('')}
              <div><h4 style="margin-top:8px">üßæ Fines</h4>${fines.length? '' : '<div class="pill">No fines found</div>'}</div>
              ${fines.map(f=>`
                <div style="border:1px solid #e5e7eb; border-radius:10px; padding:8px">

                  <div><b>#${f.fineId ?? '-'}</b> ‚Ä¢ ${f.type ?? 'FINE'}</div>

                  <div class="row" style="font-size:12px; color:#6b7280">
                    <span>${f.plate ?? '-'}</span>
                    <span>${f.amount!=null?('$ '+f.amount):''}</span>

                    <span>${fmtTs(f.fineDate)}</span>

                  </div>
                </div>`).join('')}
            </div>`;
          drawerContent.innerHTML = html;
        } catch (e) {
          drawerContent.innerHTML='<div class="pill">Error loading events</div>';
        }
      }

      // ‚úÖ ==========================================================
      // ‚úÖ SECCI√ìN 'renderSettings' MODIFICADA (tal como estaba antes)
      // ‚úÖ ==========================================================
      function renderSettings(){
        const html = `
          <div class="form-box" style="border-color: #ef4444;">
            <h4 style="margin:0 0 10px 0;">Reset Application State</h4>
            <p style="font-size:13px; color:#6b7280; margin:0 0 12px 0;">
              This will delete all saved data (device statuses, logs) and reload the
              default configuration from <code>devices.json</code> the next time the
              application server is started.
            </p>
            <button id="btnResetApp" class="btn danger">Reset and Delete Saved State</button>
          </div>

          <div class="form-box">
            <h4>Add New Car</h4>
            <div class="form-grid">

              <div class="form-group">
                <label for="carBrandSelect">Brand</label>
                <select id="carBrandSelect" class="form-select">
                  <option value="">Loading brands...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="carModelSelect">Model</label>
                <select id="carModelSelect" class="form-select" disabled>
                  <option value="">Select a brand first</option>
                </select>
              </div>

              <div class="form-group">
                <label for="carPlateInput">License Plate</label>
                <input type="text" id="carPlateInput" class="form-input" placeholder="AA123BB">
              </div>

              <div class="form-group">
                <label for="carColourInput">Colour</label>
                <input type="text" id="carColourInput" class="form-input" placeholder="Black">
              </div>

              <div class="form-group full-width">
                <label for="carOwnerInput">Owner</label>
                <input type="text" id="carOwnerInput" class="form-input" placeholder="John Doe">
              </div>

              <div class="form-group full-width">
                <label for="carAddressInput">Address</label>
                <input type="text" id="carAddressInput" class="form-input" placeholder="123 Main St">
              </div>

            </div>
            <button id="btnSaveCar" class="btn ghost" style="margin-top: 12px;">Save Car</button>
          </div>
          `;
        drawerContent.innerHTML = html;

        // --- L√≥gica para el bot√≥n de Reset (existente) ---
        document.getElementById('btnResetApp').onclick = async () => {
          if (!confirm('ARE YOU SURE?\n\nThis will delete all saved data. The application server must be manually restarted afterward.')) {
            return;
          }
          try {
            const r = await fetch('/api/system/reset', { method: 'POST' });
            const res = await r.json();
            if (!r.ok || res.ok === false) throw new Error(res.message);
            alert('SUCCESS: ' + res.message);
            closeDrawer();
          } catch (e) {
            alert('ERROR: Could not reset state.\n' + e.message);
          }
        };

        // ‚úÖ --- INICIO: L√ìGICA PARA EL FORMULARIO DE AUTOS ---
        const brandSelect = document.getElementById('carBrandSelect');
        const modelSelect = document.getElementById('carModelSelect');
        const plateInput = document.getElementById('carPlateInput');
        const colourInput = document.getElementById('carColourInput');
        const ownerInput = document.getElementById('carOwnerInput');
        const addressInput = document.getElementById('carAddressInput');
        const saveButton = document.getElementById('btnSaveCar');

        // 1. Cargar Marcas (Brands)
        async function loadCarBrands() {
          try {
            const response = await fetch('/api/cars/brands');
            if (!response.ok) throw new Error('Failed to load brands');
            const brands = await response.json();

            brandSelect.innerHTML = '<option value="">Select a brand</option>'; // Limpiar
            brands.forEach(brand => {
              brandSelect.innerHTML += `<option value="${brand.idbrand}">${brand.name}</option>`;
            });
          } catch (e) {
            brandSelect.innerHTML = '<option value="">Error loading brands</option>';
            console.error(e);
          }
        }

        // 2. Cargar Modelos (Models) cuando cambia la marca
        async function loadCarModels(brandId) {
          if (!brandId) {
            modelSelect.innerHTML = '<option value="">Select a brand first</option>';
            modelSelect.disabled = true;
            return;
          }

          modelSelect.innerHTML = '<option value="">Loading models...</option>';
          modelSelect.disabled = false;

          try {
            const response = await fetch(`/api/cars/models?brandId=${brandId}`);
            if (!response.ok) throw new Error('Failed to load models');
            const models = await response.json();

            modelSelect.innerHTML = '<option value="">Select a model</option>'; // Limpiar
            models.forEach(model => {
              modelSelect.innerHTML += `<option value="${model.modelid}">${model.name}</option>`;
            });
          } catch (e) {
            modelSelect.innerHTML = '<option value="">Error loading models</option>';
            console.error(e);
          }
        }

        // 3. Guardar el Auto
        async function saveCar() {
          const brandId = brandSelect.value;
          const modelId = modelSelect.value;
          const plate = plateInput.value.trim().toUpperCase();
          const colour = colourInput.value.trim();
          const owner = ownerInput.value.trim();
          const address = addressInput.value.trim();

          if (!brandId || !modelId || !plate || !colour || !owner || !address) {
            showToast('‚ö†Ô∏è Error', 'Please complete all fields to add a car.');
            return;
          }

          saveButton.disabled = true;
          saveButton.textContent = 'Saving...';

          try {
            const params = new URLSearchParams();
            params.append('brandId', brandId);
            params.append('modelId', modelId);
            params.append('plate', plate);
            params.append('colour', colour);
            params.append('owner', owner);
            params.append('address', address);

            const response = await fetch('/api/cars/add', {
              method: 'POST',
              body: params
            });

            const result = await response.json();
            if (!response.ok || result.ok === false) {
              throw new Error(result.message || 'Failed to save car');
            }

            showToast('‚úÖ Success', result.message || 'Car added successfully');
            // Limpiar formulario
            plateInput.value = '';
            colourInput.value = '';
            ownerInput.value = '';
            addressInput.value = '';
            brandSelect.value = '';
            modelSelect.innerHTML = '<option value="">Select a brand first</option>';
            modelSelect.disabled = true;

          } catch (e) {
            showToast('‚ùå Error', e.message);
          } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Car';
          }
        }

        // 4. Asignar Eventos
        brandSelect.addEventListener('change', () => loadCarModels(brandSelect.value));
        saveButton.addEventListener('click', saveCar);

        // 5. Carga inicial de marcas
        loadCarBrands();
        // --- ‚úÖ FIN: L√ìGICA ---
      }

      // Tabs
      tabLogs.onclick = ()=>{ selectTab(tabLogs); openDrawer('Logs'); loadLogs(); };
      tabEvents.onclick=()=>{ selectTab(tabEvents); openDrawer('Events'); loadEvents(); };
      tabFines.onclick = ()=>{ selectTab(tabFines); openDrawer('Fines'); loadFines(); };

      tabSettings.onclick = ()=>{ selectTab(tabSettings); openDrawer('Settings'); renderSettings(); };

    }); // DOMContentLoaded
</script>
</body>
</html>