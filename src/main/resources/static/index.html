<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>City Monitor</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html,body,#map{height:100%;margin:0}
        .leaflet-popup-content{font:13px/1.35 sans-serif}

        /* Empuja los controles de zoom para no tapar el header */
        .leaflet-top.leaflet-left{ top:72px; }

        /* Panel switches */
        .devices-control{position:absolute; top:84px; right:20px; z-index:900;}
        .devices-panel{background:#fff; border:1px solid #d1d5db; border-radius:12px; padding:12px; box-shadow:0 4px 10px rgba(0,0,0,0.15); min-width:220px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
        .devices-title{font-weight:600; margin-bottom:8px; text-align:center;}
        .devices-option{display:flex; align-items:center; justify-content:space-between; padding:8px 0; gap:10px; font-size:14px;}
        .switch{position:relative; display:inline-block; width:44px; height:26px; flex-shrink:0;}
        .switch input{opacity:0; width:0; height:0;}
        .switch-slider{position:absolute; cursor:pointer; inset:0; background:#d1d5db; border-radius:999px; transition:background .2s ease;}
        .switch-slider::before{content:""; position:absolute; height:22px; width:22px; left:2px; top:2px; background:#fff; border-radius:999px; box-shadow:0 1px 3px rgba(0,0,0,.25); transition: transform .2s ease;}
        .switch input:checked + .switch-slider{background:#22c55e;}
        .switch input:checked + .switch-slider::before{transform: translateX(18px);}
        .switch input:focus-visible + .switch-slider{outline:2px solid #2563eb; outline-offset:2px;}

        /* --- ESTILO PARA EL SWITCH DE FALLAS --- */
        #chkFails + .switch-slider { background: #fca5a5; } /* Color rojo claro cuando est√° apagado */
        #chkFails:checked + .switch-slider { background: #b91c1c !important; } /* Color rojo oscuro cuando est√° encendido */

        /* Header */
        .appbar{position:absolute; top:0; left:0; right:0; height:64px; background:#111827; color:#fff; z-index:950; display:flex; align-items:center; gap:14px; padding:0 16px; box-shadow: 0 6px 18px rgba(0,0,0,.35);}
        .brand{font-weight:900; letter-spacing:.5px;}
        .tab{background:transparent; border:0; color:#e5e7eb; font-weight:700; padding:8px 12px; border-radius:8px; cursor:pointer;}
        .tab[aria-selected="true"]{background:#1f2937; color:#fff;}
        .tab:hover{background:#1f2937;}
        .spacer{flex:1}

        /* Drawer */
        .drawer{position:absolute; top:64px; left:12px; z-index:920; width: 420px; max-width: calc(100% - 24px); background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 18px 40px rgba(0,0,0,.25); display:none; max-height: calc(100% - 84px); overflow-y:auto; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
        .drawer header{position:sticky; top:0; background:#f9fafb; border-bottom:1px solid #e5e7eb; padding:10px 12px; display:flex; align-items:center; gap:8px;}
        .drawer header h3{margin:0; font-size:16px;}
        .drawer .content{padding:12px;}
        .row{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
        .btn{border:1px solid #e5e7eb; background:#fff; color:#111827; border-radius:8px; padding:6px 10px; cursor:pointer;}
        .btn:disabled{background:#f3f4f6; color:#9ca3af; cursor:not-allowed;}
        .btn.ghost{background:#111827; color:#fff; border-color:#111827;}
        .btn.danger{background:#ef4444; color:#fff; border-color:#ef4444;}
        .pill{font-size:12px; background:#f3f4f6; border-radius:999px; padding:4px 8px; border:1px solid #e5e7eb;}

        /* Toast */
        #toast-container{position:fixed; top:18px; left:50%; transform:translateX(-50%); z-index:2000; display:flex; flex-direction:column; align-items:center; gap:10px; pointer-events:none; width:min(92%, 520px);}
        .toast{width:100%; background:#111827; color:white; padding:12px 16px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.08); pointer-events:auto; cursor:pointer; overflow:hidden; position:relative; animation: toast-in 250ms ease-out, toast-hold 3.2s linear 250ms, toast-out 300ms ease-in 3.45s forwards;}
        .toast .title{font-weight:700; font-size:15px; margin-bottom:4px;}
        .toast .subtitle{font-size:13px; color:#e5e7eb; opacity:.95;}
        .toast::after{content:""; position:absolute; left:0; bottom:0; height:3px; width:100%; background:#ef4444; animation: toast-bar 3.8s linear forwards;}
        @keyframes toast-in{from{opacity:0; transform: translateY(-8px);} to{opacity:1; transform: translateY(0);}}
        @keyframes toast-hold{from{opacity:1;} to{opacity:1;}}
        @keyframes toast-out{to{opacity:0; transform: translateY(-8px);}}
        @keyframes toast-bar{from{width:100%} to{width:0%}}

        /* Popups */
        .popup-card{width:240px; border-radius:12px; overflow:hidden; border:1px solid #e5e7eb; box-shadow:0 8px 20px rgba(0,0,0,0.12); background:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
        .popup-header{display:flex; align-items:center; gap:8px; padding:8px 10px; color:#fff; font-weight:700; font-size:14px;}
        .popup-body{padding:10px; color:#111827; font-size:13px;}
        .popup-row{display:flex; justify-content:space-between; padding:4px 0;}
        .popup-k{color:#6b7280;} .popup-v{font-weight:600; color:#111827;}
        .ph-radar{background:#b91c1c;} .ph-parking{background:#0b5;} .ph-camera{background:#2563eb;} .ph-sema{background:#6b7280;}

        /* Security overlay: NO abre al iniciar */
        #securityOverlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:1500; align-items:center; justify-content:center;}
        #securityOverlay.open{display:flex;}
        #securityCard{background:#111827; color:#fff; width:min(92%, 860px); border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,.45); overflow:hidden;}
        .sw-btn{background:#1f2937; color:#fff; border:1px solid #374151; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:700;}
        .sw-btn-ghost{background:transparent; border-color:#374151;}

        /* --- ESTILOS PARA EL FORMULARIO --- */
        .form-box{border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-top: 16px;}
        .form-box h4{margin:0 0 10px 0;}
        .form-grid{display:grid; grid-template-columns: 1fr 1fr; gap: 10px 12px;}
        .form-group{display:flex; flex-direction:column; gap: 4px;}
        .form-group label{font-size:13px; font-weight:600;}
        .form-input, .form-select{
            width:100%;
            padding:6px 8px;
            border-radius:8px;
            border:1px solid #d1d5db;
            background:#fff;
            font-size:14px;
            box-sizing: border-box; /* Asegura que el padding no desborde */
        }
        .form-group.full-width{grid-column: 1 / -1;}

        /* --- ESTILOS PARA PESTA√ëAS DE SETTINGS --- */
        .settings-nav {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 12px;
            gap: 4px;
        }
        .settings-tab {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-bottom: 0;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            margin-bottom: -1px; /* Solapa con el borde inferior */
        }
        .settings-tab[aria-selected="true"] {
            color: #111827;
            background: #fff;
            border-bottom: 1px solid #fff;
        }
        .settings-panel {
            display: none; /* Ocultos por defecto */
        }
        .settings-panel[data-active="true"] {
            display: block; /* Visible el activo */
        }

        /* --- ESTILOS PARA FILTROS Y GRUPOS DE MULTAS --- */
        .filter-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        .filter-select, .filter-input {
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            font-size: 13px;
            font-weight: 600;
            flex-grow: 1; /* Hace que ocupe el espacio disponible */
            box-sizing: border-box;
        }
        .filter-input {
            font-weight: normal;
        }

        .list-group-header {
            font-weight: 700;
            font-size: 16px;
            color: #111827;
            padding: 10px 4px 6px;
            border-bottom: 2px solid #e5e7eb;
            margin-top: 10px;
        }
        .list-group-header:first-child {
            margin-top: 0;
        }
        .fine-card {
            border:1px solid #e5e7eb;
            border-radius:10px;
            padding:8px;
            margin-top: 8px;
        }
        .fine-card-header {
            display:flex;
            justify-content: space-between;
            align-items: center;
        }
        .fine-card-body {
            font-size:13px;
            color:#374151;
            margin-top: 4px;
            display:flex;
            justify-content: space-between;
        }
        .fine-card-footer {
            margin-top:8px;
        }
        .fine-card-plate {
            font-weight: 600;
        }

        /* --- ESTILOS PARA REPORTES --- */
        .report-menu-item {
            display: block;
            width: 100%;
            padding: 12px 10px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            text-align: left;
            background: #fff;
        }
        .report-menu-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .report-container {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-top: 12px;
        }
        .report-header {
            background: #f9fafb;
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .report-header h4 {
            margin: 0 0 4px 0;
            font-size: 15px;
        }
        .report-header p {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }
        .report-body {
            padding: 12px;
        }
        .report-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        .report-stat-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
        }
        .report-stat-card .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }
        .report-stat-card .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .report-table th, .report-table td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }
        .report-table th {
            background: #f9fafb;
        }
        .report-table .num {
            text-align: right;
            font-weight: 600;
        }

    </style>
</head>
<body>
<div class="appbar">
    <div class="brand">City Monitor</div>
    <button id="tabLogs" class="tab" aria-selected="false">Logs</button>
    <button id="tabEvents" class="tab" aria-selected="false">Events</button>
    <button id="tabFines" class="tab" aria-selected="false">Fines</button>
    <button id="tabReports" class="tab" aria-selected="false">Reports</button>

    <button id="tabSettings" class="tab" aria-selected="false" style="margin-left:12px;">Settings</button>

    <div class="spacer"></div>
</div>

<div id="drawer" class="drawer" role="dialog" aria-modal="false" aria-hidden="true">
    <header>
        <h3 id="drawerTitle">Panel</h3>
        <div class="spacer"></div>
        <button id="drawerClose" class="btn">Close</button>
    </header>
    <div class="content" id="drawerContent"></div>
</div>

<div id="map" aria-label="City map"></div>

<div class="devices-control">
    <div id="devicesPanel" class="devices-panel" role="group" aria-label="Show devices">
        <div class="devices-title">Show devices</div>
        <div class="devices-option"><label for="chkRadars">Radars</label><label class="switch"><input type="checkbox" id="chkRadars" checked><span class="switch-slider"></span></label></div>
        <div class="devices-option"><label for="chkParking">Parking Cameras</label><label class="switch"><input type="checkbox" id="chkParking" checked><span class="switch-slider"></span></label></div>
        <div class="devices-option"><label for="chkSecurity">Cameras</label><label class="switch"><input type="checkbox" id="chkSecurity" checked><span class="switch-slider"></span></label></div>
        <div class="devices-option"><label for="chkSemaphores">Semaphores</label><label class="switch"><input type="checkbox" id="chkSemaphores" checked><span class="switch-slider"></span></label></div>

        <div class="devices-option" style="border-top:1px solid #e5e7eb; margin-top:4px; padding-top:8px;">
            <label for="chkFails" style="color:#b91c1c; font-weight:700;">Show Fails Only</label>
            <label class="switch">
                <input type="checkbox" id="chkFails">
                <span class="switch-slider"></span>
            </label>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="securityOverlay">
    <div id="securityCard">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#1f2937;">
            <div id="securityTitle" style="font-weight:800;">Security Camera</div>
            <button id="btnSecClose" aria-label="Close" style="background:transparent; border:0; color:#e5e7eb; font-size:22px; cursor:pointer;">‚úï</button>
        </div>
        <div style="display:flex; gap:16px; padding:14px;">
            <div style="flex:3; background:#0b0f17; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; min-height:420px;">
                <img id="securityImage" alt="Security frame" style="max-width:100%; max-height:70vh; display:block;">
            </div>
            <div style="flex:2; display:flex; flex-direction:column; gap:10px;">
                <div style="background:#0b0f17; border-radius:10px; padding:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">Quick Actions</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <button id="btnPolice" class="sw-btn">üöì&nbsp;Police</button>
                        <button id="btnAmb"    class="sw-btn">üöë&nbsp;Ambulance</button>
                        <button id="btnFire"   class="sw-btn">üöí&nbsp;Fire Dept.</button>
                        <button id="btnExit"   class="sw-btn sw-btn-ghost">‚úñÔ∏è&nbsp;Exit</button>
                    </div>
                </div>
                <div style="background:#0b0f17; border-radius:10px; padding:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">Note (optional)</div>
                    <textarea id="secNote" rows="4" style="width:100%; resize:vertical; background:#111827; border:1px solid #374151; color:#fff; border-radius:8px; padding:8px;"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function(){

      /* ================== MAPA ================== */
      const map = L.map('map', { zoomControl: true }).setView([-38.0, -57.55], 15);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap, ¬© CARTO' }).addTo(map);

      // --- Grupos duplicados para fallas ---
      const groups = {
        radars: L.layerGroup(),
        parking: L.layerGroup(),
        security: L.layerGroup(),
        semaphores: L.layerGroup(),
        radars_fail: L.layerGroup(),
        parking_fail: L.layerGroup(),
        security_fail: L.layerGroup(),
        semaphores_fail: L.layerGroup()
      };

      const deviceLayers = new Map();

      // --- FUNCIONES AUXILIARES ---
      function mkIcon(u){ return L.icon({iconUrl:u, iconSize:[30,30], iconAnchor:[15,30], popupAnchor:[0,-28]}); }
      const ICONS = {
        radar:   { ok: mkIcon('/images/icons/RadarPhoto.png'),         err: mkIcon('/images/icons/RadarPhotoError.png') },
        parking: { ok: mkIcon('/images/icons/ParkingCameraPhoto.png'), err: mkIcon('/images/icons/ParkingCameraPhotoError.png') },
        camera:  { ok: mkIcon('/images/icons/CameraPhoto.png'),        err: mkIcon('/images/icons/CameraPhotoError.png') }
      };
      // 'isErr' solo considera FAILURE (que el backend manda como "ERROR")
      const isErr = s => String(s||'').toUpperCase()==='ERROR';
      // 'colorFor' define los colores base
      const colorFor = s => ({GREEN:'#22c55e',YELLOW:'#facc15',RED:'#ef4444',ERROR:'#7c3aed'})[String(s||'').toUpperCase()] || '#2b2b2b';

      function header(type,title){const cls=type==='radar'?'ph-radar':type==='parking'?'ph-parking':type==='camera'?'ph-camera':'ph-sema'; const e=type==='radar'?'‚ö°':type==='parking'?'üÖøÔ∏è':type==='camera'?'üì∏':'üö¶'; return `<div class="popup-header ${cls}">${e} ${title}</div>`;}
      const row=(k,v)=>`<div class="popup-row"><span class="popup-k">${k}</span><span class="popup-v">${v}</span></div>`;
      const card=(t,id,rows)=>`<div class="popup-card">${header(t,id)}<div class="popup-body">${rows}</div></div>`;


      // --- Checkboxes globales ---
      const chkRadars = document.getElementById('chkRadars'),
            chkParking = document.getElementById('chkParking'),
            chkSecurity = document.getElementById('chkSecurity'),
            chkSemaphores = document.getElementById('chkSemaphores'),
            chkFails = document.getElementById('chkFails');

      // --- Funci√≥n de visibilidad actualizada ---
      function applyVisibility() {
        const showFailsOnly = chkFails.checked;

        const setVisibility = (normalGroup, failGroup, isChecked) => {
            map.removeLayer(normalGroup);
            map.removeLayer(failGroup);
            if (isChecked) {
                if (showFailsOnly) {
                    map.addLayer(failGroup);
                } else {
                    map.addLayer(normalGroup);
                    map.addLayer(failGroup);
                }
            }
        };

        setVisibility(groups.radars, groups.radars_fail, chkRadars.checked);
        setVisibility(groups.parking, groups.parking_fail, chkParking.checked);
        setVisibility(groups.security, groups.security_fail, chkSecurity.checked);
        setVisibility(groups.semaphores, groups.semaphores_fail, chkSemaphores.checked);
      }
      chkRadars.onchange = applyVisibility;
      chkParking.onchange = applyVisibility;
      chkSecurity.onchange = applyVisibility;
      chkSemaphores.onchange = applyVisibility;
      chkFails.onchange = applyVisibility;

      async function repairDevice(id){
        try{
          let res = await fetch(`/api/devices/${encodeURIComponent(id)}/repair`);
          if(!res.ok) res = await fetch(`/api/devices/${encodeURIComponent(id)}/status?action=REPAIR`, {method:'POST'});
          await loadDevices();
        }catch(e){console.error(e);}
      }

      // --- Llama al endpoint de MODO INTERMITENTE
      async function setIntermittentDevice(id){
        try{
          let res = await fetch(`/api/devices/${encodeURIComponent(id)}/intermittent`);
          if(!res.ok) res = await fetch(`/api/devices/${encodeURIComponent(id)}/status?action=INTERMITTENT`, {method:'POST'});
          await loadDevices(); // Recargar todo para que se vea el cambio
        }catch(e){console.error(e);}
      }

      function repairBtn(item){
        const st = String(item.status||'').toUpperCase();
        // ‚úÖ MODIFICACI√ìN: 'INTERMITTENT' ahora se maneja en 'semaphoreRepairBtns'
        if (['ERROR','FAILURE'].includes(st)){
          // Este es el bot√≥n gen√©rico para RADARES y C√ÅMARAS
          return `<div style="margin-top:8px;text-align:right"><button class="btn btn-ghost btn-rep" data-id="${item.id}">Repair</button></div>`;
        }
        return '';
      }

      // --- Botones espec√≠ficos para SEM√ÅFOROS
      function semaphoreRepairBtns(item){
        const st = String(item.status||'').toUpperCase();
        // ‚úÖ MODIFICACI√ìN: Se activa con ERROR (FAILURE) o YELLOW (INTERMITTENT)
        if (['ERROR','FAILURE','YELLOW','INTERMITTENT'].includes(st)){
          // TRADUCIDO
          return `<div style="margin-top:8px;text-align:right; display:flex; gap:6px;">
                    <button class="btn btn-ghost btn-rep-normal" data-id="${item.id}" style="flex:1;">Repair (Normal)</button>
                    <button class="btn btn-rep-interm" data-id="${item.id}" style="flex:1;">Set Intermittent</button>
                  </div>`;
        }
        return '';
      }

      // --- Handler de Clicks (con Delegaci√≥n de Eventos) ---
      function attachRepairHandlers(ev, id){
        const popupContainer = ev.popup.getElement();

        // Prevenir que un listener se a√±ada m√∫ltiples veces si Leaflet reutiliza el popup
        if (popupContainer.dataset.listenerAttached) return;
        popupContainer.dataset.listenerAttached = 'true';

        popupContainer.addEventListener('click', (e) => {
            if (e.target.closest('.btn-rep')) {
              e.stopPropagation();
              repairDevice(id);
              return;
            }
            if (e.target.closest('.btn-rep-normal')) {
              e.stopPropagation();
              repairDevice(id);
              return;
            }
            if (e.target.closest('.btn-rep-interm')) {
              e.stopPropagation();
              setIntermittentDevice(id);
              return;
            }
        });
      }

      function addDevices(data){
        Object.values(groups).forEach(g => g.clearLayers());
        deviceLayers.clear();
        const ftrs=[];

        (data.radars||[]).forEach(r=>{
          const ic=isErr(r.status)?ICONS.radar.err:ICONS.radar.ok;
          const m=L.marker([r.lat,r.lng],{icon:ic}).bindPopup(card('radar',r.id, row('Status',r.status||'?')+row('Speed limit',(r.speedLimit??r.limit??'-')+' km/h')+repairBtn(r)));
          m.on('popupopen',ev=>attachRepairHandlers(ev,r.id));
          (isErr(r.status) ? groups.radars_fail : groups.radars).addLayer(m);
          deviceLayers.set(r.id,m); ftrs.push(m);
        });
        (data.parkingCameras||[]).forEach(p=>{
          const ic=isErr(p.status)?ICONS.parking.err:ICONS.parking.ok;
          const m=L.marker([p.lat,p.lng],{icon:ic}).bindPopup(card('parking',p.id, row('Status',p.status||'?')+row('Tolerance',(p.toleranceTime??p.toleranceSec??0)+' s')+repairBtn(p)));
          m.on('popupopen',ev=>attachRepairHandlers(ev,p.id));
          (isErr(p.status) ? groups.parking_fail : groups.parking).addLayer(m);
          deviceLayers.set(p.id,m); ftrs.push(m);
        });
        (data.cameras||data.securityCameras||[]).forEach(c=>{
          const ic=isErr(c.status)?ICONS.camera.err:ICONS.camera.ok;
          const m=L.marker([c.lat,c.lng],{icon:ic}).bindPopup(card('camera',c.id, row('Status',c.status||'?')+repairBtn(c)));
          m.on('popupopen',ev=>attachRepairHandlers(ev,c.id));
          if(!isErr(c.status)){ m.on('click',()=>setTimeout(()=>openSecurityOverlay(c.id),50)); }
          (isErr(c.status) ? groups.security_fail : groups.security).addLayer(m);
          deviceLayers.set(c.id,m); ftrs.push(m);
        });

        (data.semaphores||[]).forEach(s=>{
          // ‚úÖ --- INICIO: L√ìGICA DE COLOR INICIAL MODIFICADA ---
          // s.status puede ser "READY" (normal), "ERROR" (falla), o "YELLOW" (intermitente)
          let initialColor;
          if (isErr(s.status)) {
              initialColor = colorFor('ERROR'); // Violeta
          } else if (s.status === 'YELLOW') { // 'YELLOW' es INTERMITTENT
              initialColor = colorFor('YELLOW'); // Amarillo inicial
          } else {
              initialColor = colorFor(s.a); // Ciclo normal (Rojo, Verde, o Amarillo de ciclo)
          }
          // ‚úÖ --- FIN: L√ìGICA DE COLOR INICIAL MODIFICADA ---

          const cm=L.circleMarker([s.lat,s.lng],{
            radius:7,
            fillOpacity:.95,
            color:'#000',
            weight:1,
            fillColor: initialColor, // <-- Usar el color inicial correcto
            deviceStatus: s.status  // <-- Guardamos el STATUS REAL (muy importante)
          })
          .bindPopup(card('sema',s.id, row('Dev. Status', s.status || '?') + row('Light A',s.a||'?')+row('Light B',s.b||'?')+semaphoreRepairBtns(s)));

          cm.on('popupopen',ev=>attachRepairHandlers(ev,s.id));

          // ‚úÖ MODIFICACI√ìN: Los intermitentes (s.status === 'YELLOW') van al grupo de fallas
          // para que el checkbox "Show Fails Only" los incluya.
          if (isErr(s.status) || s.status === 'YELLOW') {
            groups.semaphores_fail.addLayer(cm);
          } else {
            groups.semaphores.addLayer(cm);
          }

          deviceLayers.set(s.id,cm); ftrs.push(cm);
        });

        if(ftrs.length){const g=L.featureGroup(ftrs); map.fitBounds(g.getBounds().pad(.15));}
        applyVisibility();
      }
      async function loadDevices(){ try{ const r=await fetch('/api/devices',{cache:'no-store'}); if(!r.ok) throw 0; addDevices(await r.json()); }catch(e){ console.warn('Could not load /api/devices',e); } }
      loadDevices();


      // ‚úÖ --- INICIO: L√ìGICA DE PARPADEO ---
      let blinkState = false; // Estado global de parpadeo (toggle)

      window.updateSemaphoreStatus = (id, a, b, blinkState) => {
        const m = deviceLayers.get(id);
        if (!m) return; // No existe el marcador

        // Obtenemos el status real guardado en el marcador
        const currentStatus = m.options.deviceStatus || 'READY';
        let markerColor;

        if (currentStatus === 'ERROR') {
            // 1. Estado FAILURE (Violeta Fijo)
            markerColor = colorFor('ERROR');
        } else if (currentStatus === 'YELLOW') {
            // 2. Estado INTERMITTENT (Parpadea Amarillo/Gris)
            markerColor = blinkState ? colorFor('YELLOW') : '#6b7280'; // Alterna Amarillo y Gris
        } else {
            // 3. Estado NORMAL (Ciclo: Verde/Rojo/Amarillo de 4 seg)
            markerColor = colorFor(a); // 'a' es la luz A (principal)
        }

        // Aplicar el color al marcador
        if (m.setStyle) {
            m.setStyle({ fillColor: markerColor });
        }

        // Actualizar el popup (esto es de la correcci√≥n anterior, lo mantenemos)
        if(m.getPopup()) {
            const item = {id, status:currentStatus};
            const buttons = (currentStatus === 'ERROR' || currentStatus === 'YELLOW')
                              ? semaphoreRepairBtns(item)
                              : repairBtn(item);
            m.setPopupContent(card('sema',id, row('Dev. Status', currentStatus) + row('Light A',a||'?')+row('Light B',b||'?') + buttons));
        }
      };

      async function updateTrafficLights(){
        try {
          const r = await fetch('/api/trafficlights');
          if(!r.ok) throw 0;

          // Alternamos el estado de parpadeo UNA VEZ por ciclo de update
          blinkState = !blinkState;

          // Pasamos el estado de parpadeo a CADA sem√°foro
          (await r.json()).forEach(tl => window.updateSemaphoreStatus(tl.id, tl.a, tl.b, blinkState));
        } catch(e) {}
      }
      setInterval(updateTrafficLights, 800);
      // ‚úÖ --- FIN: L√ìGICA DE PARPADEO ---


      function showToast(title,sub){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className='toast';t.innerHTML=`<div class="title">${title}</div><div class="subtitle">${sub}</div>`;c.appendChild(t);const rm=()=>t.remove();t.addEventListener('click',rm);setTimeout(rm,4000);}
      async function checkForFines(){ try{ const r=await fetch('/api/lastFine',{cache:'no-store'}); if(!r.ok) return; const data=await r.json?.()??{}; if(!data || Object.keys(data).length===0){ const text=await r.text(); if(text&&text.trim()!==""){ showToast("üö® New fine generated","Violation PDF created."); await fetch('/api/clearFine'); } return;} if(data.fineNumber||data.plate||data.type){ const sub=`N¬∫ ${data.fineNumber??'-'} ‚Ä¢ ${data.type??'Violation'} ‚Ä¢ ${data.plate??''}`; showToast("üö® New fine generated",sub); await fetch('/api/clearFine'); } }catch(e){} }
      setInterval(checkForFines, 5000);

      /* ============ Security overlay ============ */
      const overlay=document.getElementById('securityOverlay'), imgEl=document.getElementById('securityImage'), titleEl=document.getElementById('securityTitle'), noteEl=document.getElementById('secNote'), btnClose=document.getElementById('btnSecClose'), btnPolice=document.getElementById('btnPolice'), btnAmb=document.getElementById('btnAmb'), btnFire=document.getElementById('btnFire'), btnExit=document.getElementById('btnExit');
      let currentCameraId=null, currentImagePath=null, imgsCache=null;
      async function listSecurityImages(){ if(imgsCache) return imgsCache; try{ const r=await fetch('/api/security/images',{cache:'no-store'}); if(!r.ok) throw 0; const arr=await r.json(); imgsCache=Array.isArray(arr)?arr:[]; }catch{ imgsCache=[]; } return imgsCache; }
      const pick=arr=>!arr?.length?null:arr[Math.floor(Math.random()*arr.length)];
      async function openSecurityOverlay(id){ currentCameraId=id; titleEl.textContent=`Security Camera ‚Ä¢ ${id}`; noteEl.value=''; const arr=await listSecurityImages(); currentImagePath=pick(arr) || '/images/CameraPhoto.png'; imgEl.src=currentImagePath; overlay.classList.add('open'); }
      function closeOverlay(){ overlay.classList.remove('open'); currentCameraId=null; currentImagePath=null; noteEl.value=''; }
      btnClose.onclick=closeOverlay; btnExit.onclick=closeOverlay;

      async function sendSW(service){
        if(!currentCameraId) return;
        try{
          const p=new URLSearchParams(); p.set('cameraId', currentCameraId); p.set('service', service); if(currentImagePath) p.set('imagePath', currentImagePath); const note=(noteEl.value||'').trim(); if(note) p.set('note', note);
          const r=await fetch('/api/security/notify',{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString()});
          if(!r.ok) throw 0; showToast('üìü Security notification sent', `${service} ‚Ä¢ ${currentCameraId}`); closeOverlay();
        }catch(e){ showToast('‚ö†Ô∏è Error','Could not send security notification'); }
      }
      btnPolice.onclick=()=>sendSW('POLICE');
      btnAmb.onclick   =()=>sendSW('AMBULANCE');
      btnFire.onclick  =()=>sendSW('FIREMAN');

      /* ============ Drawer (Logs / Eventos / Multas) ============ */
      const drawer=document.getElementById('drawer'), drawerTitle=document.getElementById('drawerTitle'), drawerContent=document.getElementById('drawerContent'), drawerClose=document.getElementById('drawerClose');

      // ‚úÖ Bot√≥n de Reportes A√ëADIDO
      const tabLogs=document.getElementById('tabLogs'), tabEvents=document.getElementById('tabEvents'), tabFines=document.getElementById('tabFines'), tabReports=document.getElementById('tabReports'), tabSettings=document.getElementById('tabSettings');

      function openDrawer(title){ drawerTitle.textContent=title; drawer.style.display='block'; drawer.setAttribute('aria-hidden','false'); }
      function closeDrawer(){ drawer.style.display='none'; drawer.setAttribute('aria-hidden','true'); }
      drawerClose.onclick=closeDrawer;

      // ‚úÖ Bot√≥n de Reportes A√ëADIDO
      function selectTab(btn){ [tabLogs,tabEvents,tabFines,tabReports,tabSettings].forEach(b=>b.setAttribute('aria-selected','false')); btn.setAttribute('aria-selected','true'); }

      function fmtTs(ts){
        if (!ts) return 'N/A';
        try{ return new Date(ts).toLocaleString(); }catch{ return ts; }
      }
      function fmtPct(num) {
        if (num == null) return 'N/A';
        return num.toFixed(2) + ' %';
      }
      function fmtCurrency(num) {
        if (num == null) return '';
        // Usamos 'en-US' para formato con comas y puntos, pero con prefijo $
        return '$ ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      async function loadLogs(){
        try{
          // ‚úÖ --- ARREGLO: Se llama solo a /api/security/log ---
          let r = await fetch('/api/security/log');
          if(!r.ok) throw new Error('Failed to fetch logs');

          const items = await r.json();
          items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

          const html = `
            <div class="row" style="margin-bottom:10px">
              <span class="pill">Total: ${items.length}</span>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px">
              ${items.map(it=>`
                <div class="fine-card">
                  <div><b>${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                  <div style="font-size:12px; color:#6b7280; margin-top: 4px;">${fmtTs(it.timestamp)}</div>
                  ${it.note?`<div style="margin-top:6px; font-style: italic;">${it.note}</div>`:''}
                  ${it.imagePath?`<div class="fine-card-footer"><a class="btn" href="${it.imagePath}" target="_blank" rel="noopener" style="padding: 4px 8px; font-size: 12px;">View Photo</a></div>`:''}
                </div>`).join('')}
            </div>`;
          drawerContent.innerHTML=html;
        }catch(e){
          // ‚úÖ TRADUCIDO
          drawerContent.innerHTML=`<div class="pill">Error loading logs: ${e.message}</div>`;
        }
      }

      // --- L√ìGICA PARA FILTRAR "FINES" ---
      let allFinesCache = [];
      let currentFinesSort = 'recent';

      function renderFinesList(sortBy) {
        currentFinesSort = sortBy;
        const filterSelect = document.getElementById('fines-filter-select');
        if (filterSelect) filterSelect.value = sortBy;
        const container = document.getElementById('fines-list-container');
        if (!container) return;

        let finesHtml = '';
        let filteredFines = allFinesCache;

        if (sortBy === 'recent') {
          filteredFines.sort((a, b) => new Date(b.fineDate) - new Date(a.fineDate));
          finesHtml = filteredFines.map(f => `
            <div class="fine-card">
              <div class="fine-card-header">
                <b style="font-size: 14px;">#${f.fineId ?? '-'} ‚Ä¢ ${f.type ?? 'FINE'}</b>
                <span class="pill fine-card-plate">${f.car?.plate ?? '-'}</span>
              </div>
              <div class="fine-card-body">
                <span>${fmtCurrency(f.amount)}</span>
                <span style="font-size: 12px;">${fmtTs(f.fineDate)}</span>
              </div>
              ${f.pdfPath ? `<div class="fine-card-footer"><a class="btn" href="${f.pdfPath}" target="_blank" rel="noopener" style="padding: 4px 8px; font-size: 12px;">View PDF</a></div>`: ''}
            </div>
          `).join('');
        } else if (sortBy === 'type') {
          const groups = {};
          for (const fine of filteredFines) {
            const type = fine.type || 'UNKNOWN';
            if (!groups[type]) groups[type] = [];
            groups[type].push(fine);
          }
          for (const type in groups) {
            groups[type].sort((a, b) => (b.amount || 0) - (a.amount || 0));
          }
          const sortedTypes = Object.keys(groups).sort();
          for (const type of sortedTypes) {
            finesHtml += `<h4 class="list-group-header">${type} (${groups[type].length})</h4>`;
            finesHtml += groups[type].map(f => `
              <div class="fine-card">
                <div class="fine-card-header">
                  <b style="font-size: 14px;">#${f.fineId ?? '-'}</b>
                  <span class="pill fine-card-plate">${f.car?.plate ?? '-'}</span>
                </div>
                <div class="fine-card-body">
                  <span>${fmtCurrency(f.amount)}</span>
                  <span style="font-size: 12px;">${fmtTs(f.fineDate)}</span>
                </div>
                ${f.pdfPath ? `<div class="fine-card-footer"><a class="btn" href="${f.pdfPath}" target="_blank" rel="noopener" style="padding: 4px 8px; font-size: 12px;">View PDF</a></div>`: ''}
              </div>
            `).join('');
          }
        } else {
          filteredFines = allFinesCache.filter(f => f.type === sortBy);
          filteredFines.sort((a, b) => new Date(b.fineDate) - new Date(a.fineDate));
          finesHtml = filteredFines.map(f => `
            <div class="fine-card">
              <div class="fine-card-header">
                <b style="font-size: 14px;">#${f.fineId ?? '-'} ‚Ä¢ ${f.type ?? 'FINE'}</b>
                <span class="pill fine-card-plate">${f.car?.plate ?? '-'}</span>
              </div>
              <div class="fine-card-body">
                <span>${fmtCurrency(f.amount)}</span>
                <span style="font-size: 12px;">${fmtTs(f.fineDate)}</span>
              </div>
              ${f.pdfPath ? `<div class="fine-card-footer"><a class="btn" href="${f.pdfPath}" target="_blank" rel="noopener" style="padding: 4px 8px; font-size: 12px;">View PDF</a></div>`: ''}
            </div>
          `).join('');
          if (filteredFines.length === 0) {
            // ‚úÖ TRADUCIDO
            finesHtml = '<p style="font-size: 13px; color: #6b7280; padding: 10px;">No fines found for this type.</p>';
          }
        }
        container.innerHTML = finesHtml;
      }

      async function loadFines(){
        try {
          const r = await fetch('/api/fines');
          if(!r.ok) throw new Error('Failed to fetch fines');
          allFinesCache = await r.json();

          const fineTypes = [...new Set(allFinesCache.map(f => f.type || 'UNKNOWN'))].sort();
          // ‚úÖ TRADUCIDO
          let filterOptions = `
            <option value="recent">Sort by: Most Recent</option>
            <option value="type">Sort: Grouped by Type</option>
            <optgroup label="Filter by type:">
              ${fineTypes.map(type => `<option value="${type}">Only: ${type}</option>`).join('')}
            </optgroup>
          `;

          const html = `
            <div class="row" style="margin-bottom:10px; align-items: center;">
              <button id="btnClearFines" class="btn danger">Delete all</button>
              <span class="pill" style="margin-left: 8px;">Total: ${allFinesCache.length}</span>
            </div>
            <div class="filter-nav">
              <select id="fines-filter-select" class="filter-select">
                ${filterOptions}
              </select>
            </div>
            <div id="fines-list-container" style="display:flex; flex-direction:column; gap:0px;">
            </div>`;
          drawerContent.innerHTML = html;
          renderFinesList(currentFinesSort);
          document.getElementById('btnClearFines').onclick = async ()=>{
            // ‚úÖ TRADUCIDO
            if(!confirm('Are you sure you want to delete all fines?')) return;
            try{ const r=await fetch('/api/fines',{method:'DELETE'}); if(!r.ok) throw 0; showToast('üßπ Cleaned fines','All fines were deleted successfully'); loadFines(); }catch(e){ showToast('‚ö†Ô∏è Error','Could not clear fines'); }
          };
          document.getElementById('fines-filter-select').onchange = (e) => renderFinesList(e.target.value);
        } catch(e) {
          // ‚úÖ TRADUCIDO
          drawerContent.innerHTML=`<div class="pill">Error loading fines: ${e.message}</div>`;
        }
      }

      // --- L√ìGICA PARA FILTRAR "EVENTS" ---
      let allEventsCache = { warnings: [], fines: [] };
      let currentEventsSort = 'recent';

      function renderEventsList(sortBy) {
        currentEventsSort = sortBy;
        const filterSelect = document.getElementById('events-filter-select');
        if (filterSelect) filterSelect.value = sortBy;
        const container = document.getElementById('events-list-container');
        if (!container) return;

        let html = '';
        const { warnings, fines } = allEventsCache;

        // ‚úÖ TRADUCIDO (group names)
        const allItems = [
          ...warnings.map(w => ({ ...w, sortDate: w.timestamp, itemType: 'ALERT', group: `ALERT: ${w.serviceType || 'UNKNOWN'}` })),
          ...fines.map(f => ({ ...f, sortDate: f.fineDate, itemType: 'FINE', group: `FINE: ${f.type || 'UNKNOWN'}` }))
        ];

        let itemsToRender = [];

        if (sortBy === 'recent') {
          allItems.sort((a, b) => new Date(b.sortDate) - new Date(a.sortDate));
          itemsToRender = allItems;
          html = itemsToRender.map(it => {
            // ‚úÖ TRADUCIDO
            if (it.itemType === 'ALERT') {
              return `
                <div class="fine-card">
                  <div><b>ALERT: ${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                  <div style="font-size:12px; color:#6b7280; margin-top: 4px;">${fmtTs(it.timestamp)}</div>
                  ${it.note?`<div style="margin-top:6px; font-style: italic;">${it.note}</div>`:''}
                </div>`;
            } else { // itemType === 'FINE'
              return `
                <div class="fine-card">
                  <div class="fine-card-header">
                    <b style="font-size: 14px;">FINE: #${it.fineId ?? '-'} ‚Ä¢ ${it.type ?? ''}</b>
                    <span class="pill fine-card-plate">${it.car?.plate ?? '-'}</span>
                  </div>
                  <div class="fine-card-body">
                    <span>${fmtCurrency(f.amount)}</span>
                    <span style="font-size: 12px;">${fmtTs(f.fineDate)}</span>
                  </div>
                </div>`;
            }
          }).join('');
        } else if (sortBy === 'type') {
          const groups = {};
          for (const item of allItems) {
            if (!groups[item.group]) groups[item.group] = [];
            groups[item.group].push(item);
          }
          const sortedTypes = Object.keys(groups).sort();
          for (const type of sortedTypes) {
            html += `<h4 class="list-group-header">${type} (${groups[type].length})</h4>`;
            // ‚úÖ TRADUCIDO
            if (type.startsWith('ALERT:')) {
              groups[type].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // por fecha
              html += groups[type].map(it => `
                <div class="fine-card">
                  <div><b>${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                  <div style="font-size:12px; color:#6b7280; margin-top: 4px;">${fmtTs(it.timestamp)}</div>
                  ${it.note?`<div style="margin-top:6px; font-style: italic;">${it.note}</div>`:''}
                </div>
              `).join('');
            } else {
              groups[type].sort((a, b) => (b.amount || 0) - (a.amount || 0)); // por monto
              html += groups[type].map(f => `
                <div class="fine-card">
                  <div class="fine-card-header">
                    <b style="font-size: 14px;">#${f.fineId ?? '-'}</b>
                    <span class="pill fine-card-plate">${f.car?.plate ?? '-'}</span>
                  </div>
                  <div class="fine-card-body">
                    <span>${fmtCurrency(f.amount)}</span>
                    <span style="font-size: 12px;">${fmtTs(f.fineDate)}</span>
                  </div>
                </div>
              `).join('');
            }
          }
        } else {
          itemsToRender = allItems.filter(item => item.group === sortBy);
          itemsToRender.sort((a, b) => new Date(b.sortDate) - new Date(a.sortDate));
          html = itemsToRender.map(it => {
             // ‚úÖ TRADUCIDO
             if (it.itemType === 'ALERT') {
                return `
                  <div class="fine-card">
                    <div><b>${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                    <div style="font-size:12px; color:#6b7280; margin-top: 4px;">${fmtTs(it.timestamp)}</div>
                    ${it.note?`<div style="margin-top:6px; font-style: italic;">${it.note}</div>`:''}
                  </div>`;
            } else { // itemType === 'FINE'
                return `
                  <div class="fine-card">
                    <div class="fine-card-header">
                      <b style="font-size: 14px;">#${it.fineId ?? '-'} ‚Ä¢ ${it.type ?? ''}</b>
                      <span class="pill fine-card-plate">${it.car?.plate ?? '-'}</span>
                    </div>
                    <div class="fine-card-body">
                      <span>${fmtCurrency(it.amount)}</span>
                      <span style="font-size: 12px;">${fmtTs(it.fineDate)}</span>
                    </div>
                  </div>`;
            }
          }).join('');
          if (itemsToRender.length === 0) {
             // ‚úÖ TRADUCIDO
             html = '<p style="font-size: 13px; color: #6b7280; padding: 10px;">No events found for this type.</p>';
          }
        }
        container.innerHTML = html;
      }

      async function loadEvents(){
        try {
          // ‚úÖ --- ARREGLO: Se llama solo a /api/security/log ---
          let wr = await fetch('/api/security/log');
          const fr = await fetch('/api/fines');

          if (!wr.ok) throw new Error('Failed to fetch security logs');
          if (!fr.ok) throw new Error('Failed to fetch fines');

          const warnings = await wr.json();
          const fines    = await fr.json();
          allEventsCache = { warnings, fines };

          // ‚úÖ TRADUCIDO
          const warningTypes = [...new Set(warnings.map(w => `ALERT: ${w.serviceType || 'UNKNOWN'}`))];
          const fineTypes = [...new Set(fines.map(f => `FINE: ${f.type || 'UNKNOWN'}`))];
          const allTypes = [...warningTypes, ...fineTypes].sort();

          // ‚úÖ TRADUCIDO
          let filterOptions = `
              <option value="recent">Sort by: Most Recent</option>
              <option value="type">Sort: Grouped by Type</option>
              <optgroup label="Filter by type:">
                ${allTypes.map(type => `<option value="${type}">Only: ${type}</option>`).join('')}
              </optgroup>
            `;

          // ‚úÖ TRADUCIDO
          const html = `
            <div class="row" style="margin-bottom:10px">
              <span class="pill">Security Logs: ${warnings.length}</span>
              <span class="pill">Fines: ${fines.length}</span>
            </div>
            <div class="filter-nav">
                <select id="events-filter-select" class="filter-select">
                    ${filterOptions}
                </select>
            </div>
            <div id="events-list-container" style="display:flex; flex-direction:column; gap:0px;">
                </div>
          `;
          drawerContent.innerHTML = html;
          renderEventsList(currentEventsSort);
          document.getElementById('events-filter-select').onchange = (e) => renderEventsList(e.target.value);
        } catch (e) {
          // ‚úÖ TRADUCIDO
          drawerContent.innerHTML=`<div class="pill">Error loading events: ${e.message}</div>`;
        }
      }

      // --- L√ìGICA PARA "SETTINGS" ---
      function renderSettings() {
        // ‚úÖ TRADUCIDO (Pesta√±as)
        const html = `
          <div class="settings-nav">
            <button class="settings-tab" data-tab="panel-add-car" aria-selected="true">Add Car</button>
            <button class="settings-tab" data-tab="panel-add-brand">Add Brand</button>
            <button class="settings-tab" data-tab="panel-add-model">Add Model</button>
            <button class="settings-tab" data-tab="panel-reset">Reset</button>
          </div>

          <div id="panel-add-car" class="settings-panel" data-active="true">
            <div class="form-box">
              <h4>Add New Car</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="carBrandSelect">Brand</label>
                  <select id="carBrandSelect" class="form-select">
                    <option value="">Loading brands...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="carModelSelect">Model</label>
                  <select id="carModelSelect" class="form-select" disabled>
                    <option value="">Select a brand first</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="carPlateInput">License Plate</label>
                  <input type="text" id="carPlateInput" class="form-input" placeholder="AA123BB or AAA123">
                </div>
                <div class="form-group">
                  <label for="carColourInput">Colour</label>
                  <input type="text" id="carColourInput" class="form-input" placeholder="Black">
                </div>
                <div class="form-group full-width">
                  <label for="carOwnerInput">Owner</label>
                  <input type="text" id="carOwnerInput" class="form-input" placeholder="John Doe">
                </div>
                <div class="form-group full-width">
                  <label for="carAddressInput">Address</label>
                  <input type="text" id="carAddressInput" class="form-input" placeholder="123 Main St">
                </div>
              </div>
              <button id="btnSaveCar" class="btn ghost" style="margin-top: 12px;">Save Car</button>
            </div>
          </div>

          <div id="panel-add-brand" class="settings-panel">
            <div class="form-box">
              <h4>Add New Brand</h4>
              <div class="form-grid">
                <div class="form-group full-width">
                  <label for="brandNameInput">Brand Name</label>
                  <input type="text" id="brandNameInput" class="form-input" placeholder="Example: Ford">
                </div>
              </div>
              <button id="btnSaveBrand" class="btn ghost" style="margin-top: 12px;">Save Brand</button>
            </div>
          </div>

          <div id="panel-add-model" class="settings-panel">
            <div class="form-box">
              <h4>Add New Model</h4>
              <div class="form-grid">
                <div class="form-group">
                  <label for="modelBrandSelect">Brand</label>
                  <select id="modelBrandSelect" class="form-select">
                    <option value="">Loading brands...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="modelNameInput">Model Name</label>
                  <input type="text" id="modelNameInput" class="form-input" placeholder="Example: Focus">
                </div>
              </div>
              <button id="btnSaveModel" class="btn ghost" style="margin-top: 12px;">Save Model</button>
            </div>
          </div>

          <div id="panel-reset" class="settings-panel">
            <div class="form-box" style="border-color: #ef4444;">
              <h4 style="margin:0 0 10px 0;">Reset Application State</h4>
              <p style="font-size:13px; color:#6b7280; margin:0 0 12px 0;">
                This will delete all saved data (device statuses, logs) and reload the
                default configuration from <code>devices.json</code> the next time the
                application server is started.
              </p>
              <button id="btnResetApp" class="btn danger">Reset and Delete Saved State</button>
            </div>
          </div>
        `;
        drawerContent.innerHTML = html;

        const tabs = drawerContent.querySelectorAll('.settings-tab');
        const panels = drawerContent.querySelectorAll('.settings-panel');

        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
            panels.forEach(p => p.setAttribute('data-active', 'false'));
            tab.setAttribute('aria-selected', 'true');
            const panelId = tab.getAttribute('data-tab');
            document.getElementById(panelId).setAttribute('data-active', 'true');
            if (panelId === 'panel-add-car' || panelId === 'panel-add-model') {
              loadCarBrands();
            }
          });
        });

        // ‚úÖ TRADUCIDO (Alertas)
        document.getElementById('btnResetApp').onclick = async () => {
          if (!confirm('ARE YOU SURE?\n\nThis will delete all saved data...')) { return; }
          try {
            const r = await fetch('/api/system/reset', { method: 'POST' });
            const res = await r.json();
            if (!r.ok || res.ok === false) throw new Error(res.message);
            alert('SUCCESS: ' + res.message);
            closeDrawer();
          } catch (e) {
            alert('ERROR: Could not reset state.\n' + e.message);
          }
        };

        const carBrandSelect = document.getElementById('carBrandSelect');
        const modelBrandSelect = document.getElementById('modelBrandSelect');
        const carModelSelect = document.getElementById('carModelSelect');
        const plateInput = document.getElementById('carPlateInput');
        const colourInput = document.getElementById('carColourInput');
        const ownerInput = document.getElementById('carOwnerInput');
        const addressInput = document.getElementById('carAddressInput');
        const saveCarButton = document.getElementById('btnSaveCar');
        const brandNameInput = document.getElementById('brandNameInput');
        const saveBrandButton = document.getElementById('btnSaveBrand');
        const modelNameInput = document.getElementById('modelNameInput');
        const saveModelButton = document.getElementById('btnSaveModel');

        let brandsCache = null;
        async function loadCarBrands() {
          if (brandsCache) {
            populateBrandSelects(brandsCache);
            return;
          }
          try {
            const response = await fetch('/api/cars/brands');
            if (!response.ok) throw new Error('Failed to load brands');
            brandsCache = await response.json();
            populateBrandSelects(brandsCache);
          } catch (e) {
            console.error(e);
            // ‚úÖ TRADUCIDO
            [carBrandSelect, modelBrandSelect].forEach(sel => sel.innerHTML = '<option value="">Error loading</option>');
          }
        }

        function populateBrandSelects(brands) {
          // ‚úÖ TRADUCIDO
          const defaultOption = '<option value="">Select a brand</option>';
          const optionsHtml = brands.map(b => `<option value="${b.idbrand}">${b.name}</option>`).join('');
          carBrandSelect.innerHTML = defaultOption + optionsHtml;
          modelBrandSelect.innerHTML = defaultOption + optionsHtml;
        }

        async function loadCarModels(brandId) {
          // ‚úÖ TRADUCIDO
          if (!brandId) {
            carModelSelect.innerHTML = '<option value="">Select a brand first</option>';
            carModelSelect.disabled = true;
            return;
          }
          carModelSelect.innerHTML = '<option value="">Loading models...</option>';
          carModelSelect.disabled = false;
          try {
            const response = await fetch(`/api/cars/models?brandId=${brandId}`);
            if (!response.ok) throw new Error('Failed to load models');
            const models = await response.json();
            carModelSelect.innerHTML = '<option value="">Select a model</option>';
            models.forEach(model => {
              carModelSelect.innerHTML += `<option value="${model.modelid}">${model.name}</option>`;
            });
          } catch (e) {
            // ‚úÖ TRADUCIDO
            carModelSelect.innerHTML = '<option value="">Error loading models</option>';
            console.error(e);
          }
        }

        async function saveBrand() {
          const name = brandNameInput.value.trim();
          if (!name) {
            // ‚úÖ TRADUCIDO
            showToast('‚ö†Ô∏è Error', 'Please enter a brand name.');
            return;
          }
          saveBrandButton.disabled = true;
          saveBrandButton.textContent = 'Saving...';
          try {
            const params = new URLSearchParams();
            params.append('name', name);
            const response = await fetch('/api/cars/brands/add', { method: 'POST', body: params });
            const result = await response.json();
            if (!response.ok || result.ok === false) throw new Error(result.message);
            showToast('‚úÖ Success', result.message);
            brandNameInput.value = '';
            brandsCache = null;
          } catch (e) {
            showToast('‚ùå Error', e.message);
          } finally {
            // ‚úÖ TRADUCIDO
            saveBrandButton.disabled = false;
            saveBrandButton.textContent = 'Save Brand';
          }
        }

        async function saveModel() {
          const brandId = modelBrandSelect.value;
          const name = modelNameInput.value.trim();
          if (!brandId || !name) {
            // ‚úÖ TRADUCIDO
            showToast('‚ö†Ô∏è Error', 'Please select a brand and enter a model name.');
            return;
          }
          saveModelButton.disabled = true;
          saveModelButton.textContent = 'Saving...';
          try {
            const params = new URLSearchParams();
            params.append('brandId', brandId);
            params.append('name', name);
            const response = await fetch('/api/cars/models/add', { method: 'POST', body: params });
            const result = await response.json();
            if (!response.ok || result.ok === false) throw new Error(result.message);
            showToast('‚úÖ Success', result.message);
            modelNameInput.value = '';
            modelBrandSelect.value = '';
          } catch (e) {
            showToast('‚ùå Error', e.message);
          } finally {
            // ‚úÖ TRADUCIDO
            saveModelButton.disabled = false;
            saveModelButton.textContent = 'Save Model';
          }
        }

        async function saveCar() {
          const brandId = carBrandSelect.value;
          const modelId = carModelSelect.value;
          const plate = plateInput.value.trim().toUpperCase();
          const colour = colourInput.value.trim();
          const owner = ownerInput.value.trim();
          const address = addressInput.value.trim();

          if (!brandId || !modelId || !plate || !colour || !owner || !address) {
            // ‚úÖ TRADUCIDO
            showToast('‚ö†Ô∏è Error', 'Please complete all fields to add a car.');
            return;
          }

          const plateRegex = /^([A-Z]{3}\d{3}|[A-Z]{2}\d{3}[A-Z]{2})$/;
          if (!plateRegex.test(plate)) {
            // ‚úÖ TRADUCIDO
            showToast('‚ùå Invalid Plate', 'Format must be AAA123 or AA123BB.');
            return;
          }

          saveCarButton.disabled = true;
          saveCarButton.textContent = 'Saving...';
          try {
            const params = new URLSearchParams();
            params.append('brandId', brandId);
            params.append('modelId', modelId);
            params.append('plate', plate);
            params.append('colour', colour);
            params.append('owner', owner);
            params.append('address', address);

            const response = await fetch('/api/cars/add', { method: 'POST', body: params });
            const result = await response.json();
            if (!response.ok || result.ok === false) throw new Error(result.message);

            showToast('‚úÖ Success', result.message);
            plateInput.value = '';
            colourInput.value = '';
            ownerInput.value = '';
            addressInput.value = '';
            carBrandSelect.value = '';
            // ‚úÖ TRADUCIDO
            carModelSelect.innerHTML = '<option value="">Select a brand first</option>';
            carModelSelect.disabled = true;
          } catch (e) {
            showToast('‚ùå Error', e.message);
          } finally {
            // ‚úÖ TRADUCIDO
            saveCarButton.disabled = false;
            saveCarButton.textContent = 'Save Car';
          }
        }

        carBrandSelect.addEventListener('change', () => loadCarModels(carBrandSelect.value));
        saveCarButton.addEventListener('click', saveCar);
        saveBrandButton.addEventListener('click', saveBrand);
        saveModelButton.addEventListener('click', saveModel);

        loadCarBrands();
      }

      // --- L√ìGICA DE REPORTES ---

      // ‚úÖ TRADUCIDO (Men√∫ de Reportes)
      function renderReportsMenu() {
        drawerContent.innerHTML = `
          <button class="report-menu-item" id="btn-report-devices">1. Device Status Report</button>
          <button class="report-menu-item" id="btn-report-fines">2. Fines Summary Report</button>
          <button class="report-menu-item" id="btn-report-plate">3. Fines by Plate Report</button>
          <button class="report-menu-item" id="btn-report-security">4. Security Logs Report</button>
          <button class="report-menu-item" id="btn-report-events">5. Events by Device Report</button>
        `;
        // Asignar clicks
        document.getElementById('btn-report-devices').onclick = renderDeviceStatusReport;
        document.getElementById('btn-report-fines').onclick = renderFinesSummaryReport;
        document.getElementById('btn-report-plate').onclick = renderFinesByPlateReport;
        document.getElementById('btn-report-security').onclick = renderSecurityLogsReport;
        document.getElementById('btn-report-events').onclick = renderDeviceEventsReport;
      }

      // ‚úÖ TRADUCIDO (Reporte 1)
      async function renderDeviceStatusReport() {
        const html = `
          <button class="btn" id="btn-back-reports">‚Üê Back to Menu</button>
          <div class="form-box" style="margin-top: 12px;">
            <h4>Report 1: Device Status</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Filter by Type</label>
                <select id="rep1-type" class="filter-select">
                  <option value="ALL">All Types</option>
                  <option value="Radar">Radar</option>
                  <option value="ParkingCamera">ParkingCamera</option>
                  <option value="SecurityCamera">SecurityCamera</option>
                  <option value="TrafficLight">TrafficLight</option>
                </select>
              </div>
              <div class="form-group">
                <label>Filter by Status</label>
                <select id="rep1-status" class="filter-select">
                  <option value="ALL">All Statuses</option>
                  <option value="NORMAL">Normal</option>
                  <option value="FAILURE">With Failure</option>
                </select>
              </div>
            </div>
            <button id="rep1-run" class="btn ghost" style="margin-top: 12px;">Generate Report</button>
          </div>
          <div id="rep1-results" style="margin-top: 12px;"></div>
        `;
        drawerContent.innerHTML = html;
        document.getElementById('btn-back-reports').onclick = renderReportsMenu;
        document.getElementById('rep1-run').onclick = async () => {
          const type = document.getElementById('rep1-type').value;
          const status = document.getElementById('rep1-status').value;
          const resultsEl = document.getElementById('rep1-results');
          resultsEl.innerHTML = `<span class="pill">Loading...</span>`;

          try {
            const res = await fetch(`/api/reports/device-status?type=${type}&status=${status}`);
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();

            resultsEl.innerHTML = `
              <div class="report-container">
                <div class="report-header">
                  <h4>Report Results</h4>
                  <p>Generated: ${data.reportTimestamp}</p>
                </div>
                <div class="report-body">
                  <div class="report-stat-grid">
                    <div class="report-stat-card">
                      <div class="stat-value">${data.totalNormal}</div>
                      <div class="stat-label">Normal (${fmtPct(data.pctNormal)})</div>
                    </div>
                    <div class="report-stat-card" style="border-color: #ef4444;">
                      <div class="stat-value">${data.totalFailure}</div>
                      <div class="stat-label">With Failure (${fmtPct(data.pctFailure)})</div>
                    </div>
                  </div>

                  <h5 style="margin: 16px 0 8px 0;">Breakdown by Type</h5>
                  <table class="report-table">
                    <thead><tr><th>Device Type</th><th>Total</th></tr></thead>
                    <tbody>
                    ${Object.entries(data.countByType).map(([key, val]) => `
                      <tr><td>${key}</td><td class="num">${val}</td></tr>
                    `).join('')}
                      <tr style="background: #f3f4f6;">
                        <th>Grand Total</th>
                        <th class="num">${data.totalDevices}</th>
                      </tr>
                    </tbody>
                  </table>

                  <h5 style="margin: 16px 0 8px 0;">Device List (${data.devices.length})</h5>
                  <table class="report-table">
                    <thead><tr><th>ID</th><th>Type</th><th>Status</th></tr></thead>
                    <tbody>
                    ${data.devices.map(d => `
                      <tr>
                        <td>${d.deviceId}</td>
                        <td>${d.type}</td>
                        <td style="color: ${d.status === 'NORMAL' || d.status === 'UNKNOWN' ? 'green' : 'red'}">${d.status}</td>
                      </tr>
                    `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          } catch (e) {
            resultsEl.innerHTML = `<span class="pill danger">Error loading report: ${e.message}</span>`;
          }
        };
      }

      // ‚úÖ TRADUCIDO (Reporte 2)
      async function renderFinesSummaryReport() {
        drawerContent.innerHTML = `
          <button class="btn" id="btn-back-reports">‚Üê Back to Menu</button>
          <div id="rep2-results" style="margin-top: 12px;"><span class="pill">Loading...</span></div>
        `;
        document.getElementById('btn-back-reports').onclick = renderReportsMenu;

        try {
            const res = await fetch(`/api/reports/fines`);
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();
            const stats = data.globalStats;

            let groupsHtml = data.groups.map(g => `
              <h5 style="margin: 16px 0 8px 0;">Group: ${g.type}</h5>
              <table class="report-table">
                <thead>
                  <tr><th>Fine ID</th><th>Plate</th><th>Amount</th></tr>
                </thead>
                <tbody>
                ${g.fines.map(f => `
                  <tr>
                    <td>#${f.fineId}</td>
                    <td>${f.car?.plate ?? '-'}</td>
                    <td class="num">${fmtCurrency(f.amount)}</td>
                  </tr>`).join('')}
                  <tr style="background: #f3f4f6;">
                    <th colspan="2">Group Total (${g.count} fines)</th>
                    <th class="num">${fmtCurrency(g.totalAmount)}</th>
                  </tr>
                </tbody>
              </table>
            `).join('');

            document.getElementById('rep2-results').innerHTML = `
              <div class="report-container">
                <div class="report-header"><h4>Report 2: Fines Summary</h4></div>
                <div class="report-body">
                  <h5 style="margin: 0 0 8px 0;">Final Summary</h5>
                  <table class="report-table">
                    <tbody>
                      <tr><td>Total Fines Count</td><td class="num">${stats.totalCount}</td></tr>
                      <tr><td>Total Fines Amount</td><td class="num">${fmtCurrency(stats.totalAmount)}</td></tr>
                      <tr><td>Average Fine Amount</td><td class="num">${fmtCurrency(stats.averageAmount)}</td></tr>
                      <tr><td>Minimum Fine Amount</td><td class="num">${fmtCurrency(stats.minAmount)}</td></tr>
                      <tr><td>Maximum Fine Amount</td><td class="num">${fmtCurrency(stats.maxAmount)}</td></tr>
                    </tbody>
                  </table>
                  ${groupsHtml}
                </div>
              </div>
            `;
        } catch (e) {
            document.getElementById('rep2-results').innerHTML = `<span class="pill danger">Error loading report: ${e.message}</span>`;
        }
      }

      // ‚úÖ TRADUCIDO (Reporte 3)
      function renderFinesByPlateReport() {
        const html = `
          <button class="btn" id="btn-back-reports">‚Üê Back to Menu</button>
          <div class="form-box" style="margin-top: 12px;">
            <h4>Report 3: Fines by Plate</h4>
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Enter License Plate (e.g., AA123BB)</label>
                <input type="text" id="rep3-plate" class="filter-input" placeholder="AA123BB">
              </div>
            </div>
            <button id="rep3-run" class="btn ghost" style="margin-top: 12px;">Search</button>
          </div>
          <div id="rep3-results" style="margin-top: 12px;"></div>
        `;
        drawerContent.innerHTML = html;
        document.getElementById('btn-back-reports').onclick = renderReportsMenu;
        document.getElementById('rep3-run').onclick = async () => {
          const plate = document.getElementById('rep3-plate').value.trim().toUpperCase();
          const resultsEl = document.getElementById('rep3-results');
          if (!plate) {
            resultsEl.innerHTML = `<span class="pill">Please enter a license plate.</span>`;
            return;
          }
          resultsEl.innerHTML = `<span class="pill">Searching...</span>`;
          try {
            const res = await fetch(`/api/reports/fines-by-plate?plate=${plate}`);
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();

            if (data.length === 0) {
              resultsEl.innerHTML = `<span class="pill">No fines found for plate ${plate}.</span>`;
              return;
            }

            resultsEl.innerHTML = `
              <div class="report-container">
                <div class="report-header"><h4>Fines for ${plate} (${data.length})</h4></div>
                <div class="report-body">
                  <table class="report-table">
                    <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Device</th></tr></thead>
                    <tbody>
                    ${data.map(f => `
                      <tr>
                        <td>${fmtTs(f.fineDate)}</td>
                        <td>${f.type}</td>
                        <td class="num">${fmtCurrency(f.amount)}</td>
                        <td>${f.deviceId}</td>
                      </tr>
                    `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          } catch (e) {
            resultsEl.innerHTML = `<span class="pill danger">Error loading report: ${e.message}</span>`;
          }
        };
      }

      // ‚úÖ TRADUCIDO (Reporte 4)
      function renderSecurityLogsReport() {
        const html = `
          <button class="btn" id="btn-back-reports">‚Üê Back to Menu</button>
          <div class="form-box" style="margin-top: 12px;">
            <h4>Report 4: Security Logs</h4>
            <p style="font-size:12px; color:#6b7280; margin:4px 0 12px 0;">Filter by date range (optional)</p>
            <div class="form-grid">
              <div class="form-group">
                <label>From</label>
                <input type="datetime-local" id="rep4-start" class="filter-input">
              </div>
              <div class="form-group">
                <label>To</label>
                <input type="datetime-local" id="rep4-end" class="filter-input">
              </div>
            </div>
            <button id="rep4-run" class="btn ghost" style="margin-top: 12px;">Generate Report</button>
          </div>
          <div id="rep4-results" style="margin-top: 12px;"></div>
        `;
        drawerContent.innerHTML = html;
        document.getElementById('btn-back-reports').onclick = renderReportsMenu;
        document.getElementById('rep4-run').onclick = async () => {
          const start = document.getElementById('rep4-start').value;
          const end = document.getElementById('rep4-end').value;
          const resultsEl = document.getElementById('rep4-results');
          resultsEl.innerHTML = `<span class="pill">Loading...</span>`;

          try {
            const res = await fetch(`/api/reports/security-logs?start=${start}&end=${end}`);
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();

            resultsEl.innerHTML = `
              <div class="report-container">
                <div class="report-header"><h4>Results (${data.totalCount} alerts)</h4></div>
                <div class="report-body">
                  <h5 style="margin: 0 0 8px 0;">Total by Service</h5>
                  <table class="report-table">
                    <thead><tr><th>Service</th><th>Count</th><th>Percentage</th></tr></thead>
                    <tbody>
                    ${Object.entries(data.counts).map(([key, val]) => `
                      <tr>
                        <td>${key}</td>
                        <td class="num">${val}</td>
                        <td class="num">${fmtPct(data.percentages[key] || 0)}</td>
                      </tr>
                    `).join('')}
                      <tr style="background: #f3f4f6;">
                        <th>Grand Total</th>
                        <th class="num">${data.totalCount}</th>
                        <th class="num">100.00 %</th>
                      </tr>
                    </tbody>
                  </table>

                  <h5 style="margin: 16px 0 8px 0;">Alert List (${data.warnings.length})</h5>
                  <div style="display:flex; flex-direction:column; gap:8px">
                    ${data.warnings.map(it =>`
                      <div class="fine-card">
                        <div><b>${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                        <div style="font-size:12px; color:#6b7280; margin-top: 4px;">${fmtTs(it.timestamp)}</div>
                        ${it.note?`<div style="margin-top:6px; font-style: italic;">${it.note}</div>`:''}
                      </div>`).join('')}
                  </div>
                </div>
              </div>
            `;
          } catch (e) {
            resultsEl.innerHTML = `<span class="pill danger">Error loading report: ${e.message}</span>`;
          }
        };
      }

      // ‚úÖ TRADUCIDO (Reporte 5)
      async function renderDeviceEventsReport() {
        let deviceOptions = '<option value="">Loading devices...</option>';
        try {
          const res = await fetch('/api/reports/device-ids');
          const ids = await res.json();
          deviceOptions = '<option value="">Select a device</option>' +
            ids.map(id => `<option value="${id}">${id}</option>`).join('');
        } catch (e) {
          deviceOptions = '<option value="">Error loading</option>';
        }

        const html = `
          <button class="btn" id="btn-back-reports">‚Üê Back to Menu</button>
          <div class="form-box" style="margin-top: 12px;">
            <h4>Report 5: Events by Device</h4>
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Select Device</label>
                <select id="rep5-device" class="filter-select">
                  ${deviceOptions}
                </select>
              </div>
            </div>
            <button id="rep5-run" class="btn ghost" style="margin-top: 12px;">Search</button>
          </div>
          <div id="rep5-results" style="margin-top: 12px;"></div>
        `;
        drawerContent.innerHTML = html;
        document.getElementById('btn-back-reports').onclick = renderReportsMenu;
        document.getElementById('rep5-run').onclick = async () => {
          const deviceId = document.getElementById('rep5-device').value;
          const resultsEl = document.getElementById('rep5-results');
          if (!deviceId) {
            resultsEl.innerHTML = `<span class="pill">Please select a device.</span>`;
            return;
          }
          resultsEl.innerHTML = `<span class="pill">Searching...</span>`;

          try {
            const res = await fetch(`/api/reports/device-events?deviceId=${deviceId}`);
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();

            if (data.totalEvents === 0) {
              resultsEl.innerHTML = `<span class="pill">No events found for ${deviceId}.</span>`;
              return;
            }

            resultsEl.innerHTML = `
              <div class="report-container">
                <div class="report-header">
                  <h4>Events for ${deviceId}</h4>
                  <p>Total: ${data.totalEvents} (${data.fines.length} fines, ${data.warnings.length} alerts)</p>
                </div>
                <div class="report-body">
                  <h5 style="margin: 0 0 8px 0;">Fines (${data.fines.length})</h5>
                  ${data.fines.length === 0 ? '<p style="font-size:13px; color:#6b7280;">No fines.</p>' : `
                  <table class="report-table">
                    <thead><tr><th>Date</th><th>Type</th><th>Plate</th><th>Amount</th></tr></thead>
                    <tbody>
                    ${data.fines.map(f => `
                      <tr>
                        <td>${fmtTs(f.fineDate)}</td>
                        <td>${f.type}</td>
                        <td>${f.car?.plate ?? '-'}</td>
                        <td class="num">${fmtCurrency(f.amount)}</td>
                      </tr>
                    `).join('')}
                    </tbody>
                  </table>
                  `}

                  <h5 style="margin: 16px 0 8px 0;">Security Alerts (${data.warnings.length})</h5>
                  ${data.warnings.length === 0 ? '<p style="font-size:13px; color:#6b7280;">No alerts.</p>' : `
                  <div style="display:flex; flex-direction:column; gap:8px">
                    ${data.warnings.map(it =>`
                      <div class="fine-card">
                        <div><b>${it.serviceType}</b> ‚Ä¢ <span class="pill">${it.deviceId}</span></div>
                        <div style="font-size:12px; color:#6b7280; margin-top: 4px;">${fmtTs(it.timestamp)}</div>
                        ${it.note?`<div style="margin-top:6px; font-style: italic;">${it.note}</div>`:''}
                      </div>`).join('')}
                  </div>
                  `}
                </div>
              </div>
            `;
          } catch (e) {
            resultsEl.innerHTML = `<span class="pill danger">Error loading report: ${e.message}</span>`;
          }
        };
      }

      // --- Asignaci√≥n de Pesta√±as ---
      tabLogs.onclick = ()=>{ selectTab(tabLogs); openDrawer('Logs'); loadLogs(); };
      tabEvents.onclick=()=>{ selectTab(tabEvents); openDrawer('Events'); loadEvents(); };
      tabFines.onclick = ()=>{ selectTab(tabFines); openDrawer('Fines'); loadFines(); };
      tabReports.onclick = ()=>{ selectTab(tabReports); openDrawer('Reports'); renderReportsMenu(); };
      tabSettings.onclick = ()=>{ selectTab(tabSettings); openDrawer('Settings'); renderSettings(); };

    }); // DOMContentLoaded
</script>
</body>
</html>