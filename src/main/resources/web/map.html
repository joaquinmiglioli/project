<!doctype html>
<html><head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        html,body,#map{height:100%;margin:0}
        .leaflet-popup-content { font: 13px/1.2 sans-serif; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map',{ zoomControl:true }).setView([-38.0,-57.55], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'© OpenStreetMap' }).addTo(map);

    const layers = {}; // id -> marker/circle

    function colorFor(status){
      switch((status||'').toUpperCase()){
        case 'GREEN': return '#22c55e';
        case 'YELLOW':return '#facc15';
        case 'RED':   return '#ef4444';
        case 'ERROR': return '#7c3aed';
        default:      return '#2b2b2b';
      }
    }

    window.setView = (lat,lng,zoom)=> map.setView([lat,lng], zoom);

    window.addDevices = (jsonStr)=>{
      const data = JSON.parse(jsonStr);

      // Semáforos como CircleMarker con color por estado
      (data.semaphoreControllers||[]).forEach(sc=>{
        const m = L.circleMarker([sc.lat, sc.lng], {
          radius: 7, fillOpacity: 0.95, color:'#000', weight:1, fillColor: colorFor(sc.status)
        }).addTo(map).bindPopup(sc.id);
        m.on('click', ()=> window.appBridge && window.appBridge.onMarkerClicked(sc.id));
        layers[sc.id]=m;
      });

      // Radares / cámaras: marcador default
      const addPoint = (d)=> {
        const m = L.marker([d.lat, d.lng]).addTo(map).bindPopup(d.id);
        m.on('click', ()=> window.appBridge && window.appBridge.onMarkerClicked(d.id));
        layers[d.id] = m;
      };
      (data.radars||[]).forEach(addPoint);
      (data.securityCameras||[]).forEach(addPoint);
      (data.parkingCameras||[]).forEach(pc=>{
        const m = L.marker([pc.lat, pc.lng]).addTo(map)
          .bindPopup(pc.id + " (tol " + (pc.toleranceTime||0) + "s)");
        m.on('click', ()=> window.appBridge && window.appBridge.onMarkerClicked(pc.id));
        layers[pc.id]=m;
      });

      // Fit a todos
      const group = L.featureGroup(Object.values(layers));
      if(Object.values(layers).length) map.fitBounds(group.getBounds().pad(0.15));
    };

    window.updateSemaphoreStatus = (id, status)=>{
      const m = layers[id];
      if(m && m.setStyle) m.setStyle({ fillColor: colorFor(status) });
    };
</script>
</body></html>
